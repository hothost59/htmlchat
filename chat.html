<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<title>Modern Chat Application</title>
		<meta name="viewport" content="width=device-width,initial-scale=1" />
		<style>
			/* --- THEME & GLOBAL STYLES --- */
			:root {
				--bg: #36393f; --panel: #2f3136; --muted: #b9bbbe;
				--accent: #7289da; --card: #4f545c; --card-hover: #5b616b;
				--sidebar-grad: linear-gradient(to bottom, #2f3136, #202225);
				--text: #e6e6e6;
				--input-bg: #202225;
				--auth-grad: linear-gradient(135deg, var(--panel), #202225);
				--channel-bg: #99aab5;
				--channel-text: #000000;
			}
			.light {
				--bg: #f4f6f8; --panel: #ffffff; --muted: #6b7280;
				--accent: #4f46e5; --card: #f3f4f6; --text: #111827;
				--sidebar-grad: linear-gradient(to bottom, #ffffff, #f1f5f9);
				--input-bg: #e5e7eb;
				--auth-grad: linear-gradient(135deg, var(--panel), #f9fafb);
				--channel-bg: #e5e7eb;
				--channel-text: #1f2937;
			}
			html, body {
				height: 100%; width: 100%; margin: 0; padding: 0;
				overflow: hidden;
				font-family: "Segoe UI", Roboto, system-ui, -apple-system, "Helvetica Neue", Arial;
				color: var(--text);
			}
			body {
				background: var(--bg); display: flex; flex-direction: column;
				align-items: stretch;
			}
			
			/* --- AUTH & LAYOUT --- */
			#authDiv {
				position: absolute; inset: 0; display: flex; align-items: center;
				justify-content: center; z-index: 40;
			}
			.authCard {
				width: 360px; background: var(--auth-grad);
				border-radius: 14px; padding: 22px;
				box-shadow: 0 14px 40px rgba(0,0,0,0.6);
				display: flex; flex-direction: column; gap: 12px;
			}
			.authTabs { display: flex; gap: 8px; }
			.authTabs button {
				flex: 1; padding: 10px; border-radius: 10px; border: none; cursor: pointer;
				background: var(--accent); color: white; font-weight: 600; transition: all .18s;
			}
			.authTabs button.active { opacity: 0.9; }
			.authCard input {
				width: 100%; padding: 12px; border-radius: 10px; border: none;
				background: var(--input-bg); color: var(--text);
			}
			#app {
				flex: 1; min-height: 0; display: flex;
				gap: 0; align-items: stretch;
			}
			#sidebar{width:300px;background:var(--sidebar-grad);padding:14px;display:flex;flex-direction:column;box-shadow:2px 0 18px rgba(0,0,0,0.35);gap:10px}
			#sidebarHeader{font-weight:800;font-size:18px;display:flex;align-items:center;justify-content:space-between}
			#sidebarHeader .controls{display:flex;gap:8px;align-items:center}
			#main{flex:1;display:flex;flex-direction:column;background:var(--bg);min-width:0}
			#chatHeader{padding:12px 16px;background:var(--panel);border-bottom:1px solid rgba(255,255,255,0.03);font-weight:800;display:flex;justify-content:space-between;align-items:center}
			#chatHeader .meta{display:flex;gap:10px;align-items:center;color:var(--muted);font-weight:600;font-size:13px}
			#bottomBar{display:flex;gap:12px;padding:12px;background:var(--sidebar-grad);align-items:center}
			#msgInput{flex:1;padding:12px 14px;border-radius:12px;border:none;background:var(--input-bg); color:var(--text); font-size:15px}
			.sidebarButtons{display:flex; flex-direction: column; gap:8px;margin-top:10px}
			
			/* --- CHANNELS & USER LIST --- */
			#channelList{flex:1;overflow:auto;display:flex;flex-direction:column;gap:8px;padding-right:4px}
			.channelRow{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:8px 10px;border-radius:10px;background: var(--channel-bg); color: var(--channel-text); font-weight:700;cursor:pointer;transition:all .18s}
			.channelRow:hover{transform:scale(1.02);background:var(--accent);color:white}
			.channelRow.active{background:var(--accent);color:white;transform:scale(1.02)}
			.channelLeft{display:flex;gap:8px;align-items:center}
			.badge{background:#ff5b5b;color:white;border-radius:999px;padding:2px 8px;font-size:12px;font-weight:700}
			#rightbar{width:260px;background:var(--panel);padding:12px 10px;display:flex;flex-direction:column;gap:10px;box-shadow:-2px 0 18px rgba(0,0,0,0.18)}
			#usersHeader{display:flex;justify-content:space-between;align-items:center;font-weight:800}
			.userRow{display:flex;gap:10px;align-items:center;padding:6px;border-radius:8px;cursor:default}
			.userRow:hover{background:rgba(255,255,255,0.02)}
			.statusDot{width:10px;height:10px;border-radius:50%}
			.status-online{background:#2ecc71}
			.status-away{background:#f1c40f}
			.status-offline{background:#95a5a6}
			.userName{font-weight:700}
			
			/* --- MESSAGES & SCROLL --- */
			#messages{flex:1;padding:14px;overflow:auto;display:flex;flex-direction:column;gap:8px}
			.message{display:flex;gap:12px;align-items:flex-start;max-width:980px;transition:all .28s;opacity:0;transform:translateY(10px); position: relative;}
			.message.show{opacity:1;transform:translateY(0)}
			.avatar{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;color:white;background:#6b6f75;flex:0 0 40px}
			.msgBody{background:var(--card);padding:8px 12px;border-radius:10px;min-width:0}
			.msgHeader{font-weight:700;font-size:14px;display:flex;gap:8px;align-items:center}
			.timestamp{color:var(--muted);font-size:12px;font-weight:600}
			.msgText{margin-top:4px;color:var(--text);white-space:pre-wrap;word-break:break-word}
			.message.system .msgBody{background:var(--accent);color:white;font-weight:700}
			.grouped .avatar, .grouped .msgHeader .username{visibility:hidden;width:0;margin-right:0}
			.compact .msgBody{padding:6px 8px;border-radius:8px}
			.compact .avatar{width:32px;height:32px;flex:0 0 32px}
			.message-menu {position: absolute; top: -10px; right: 10px; background: var(--panel); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.4); padding: 4px; display: none; cursor: pointer; z-index: 10; gap: 4px;}
			.message:hover .message-menu { display: flex; }
			.menu-item {padding: 6px 8px; border-radius: 4px; font-size: 13px; font-weight: 600;}
			.menu-item:hover { background: var(--accent); color: white; }
			.edited-indicator { font-size: 10px; color: var(--muted); margin-left: 8px; }
			textarea.edit-input { width: 98%; background: var(--bg); color: var(--text); border: 1px solid var(--accent); border-radius: 5px; font-family: inherit; font-size: inherit; resize: none; }
			.edit-helper-text { font-size: 11px; color: var(--muted); margin-top: 4px; }
			#scrollBtn{position:fixed;right:26px;bottom:96px;padding:10px 12px;border-radius:12px;border:none;background:var(--accent);color:white;cursor:pointer;opacity:0;transition:opacity .25s, transform .18s}
			#scrollBtn.show{opacity:1;transform:translateY(0)}
			#scrollBtn:hover{transform:translateY(-3px)}
			
			/* --- UPGRADED PRIMARY & MODAL BUTTONS --- */
			#submitBtn, .sidebarButtons button, #sendBtn, .modalActions button {
				padding: 12px 16px; border-radius: 8px; border: none;
				background-image: linear-gradient(to top, var(--accent) 0%, #8ea4eb 100%);
				color: white; font-weight: 700; cursor: pointer;
				box-shadow: 0 2px 5px rgba(0,0,0,0.2), inset 0 1px 1px rgba(255,255,255,0.1);
				transition: all 0.2s ease-in-out; text-shadow: 0 1px 2px rgba(0,0,0,0.2);
			}
			#submitBtn:hover, .sidebarButtons button:hover, #sendBtn:hover, .modalActions button:hover {
				transform: translateY(-2px);
				box-shadow: 0 4px 8px rgba(0,0,0,0.3), inset 0 1px 1px rgba(255,255,255,0.1);
				filter: brightness(1.1);
			}
			#submitBtn:active, .sidebarButtons button:active, #sendBtn:active, .modalActions button:active {
				transform: translateY(1px);
				box-shadow: 0 1px 2px rgba(0,0,0,0.4), inset 0 1px 1px rgba(0,0,0,0.2);
				filter: brightness(0.95);
			}
			
			/* --- UPGRADED TINY ICON BUTTONS --- */
			.tinyBtn {
				background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
				padding: 6px 8px; border-radius: 8px; color: var(--muted);
				cursor: pointer; transition: all 0.2s ease;
			}
			.tinyBtn:hover {
				background: rgba(255,255,255,0.1); color: var(--text);
				transform: translateY(-1px); border-color: rgba(255,255,255,0.15);
			}
			
			/* --- MODALS & SETTINGS --- */
			#modalOverlay{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center; z-index: 50;}
			.modalCard{background:var(--panel);padding:18px;border-radius:12px;width:380px;display:flex;flex-direction:column;gap:10px}
			.modalCard input{padding:10px;border-radius:8px;border:none;background:var(--input-bg);color:var(--text)}
			.modalActions{display:flex;gap:8px;justify-content:flex-end}
			.modal-subtitle { font-size: 14px; color: var(--muted); margin-bottom: 10px; }
			#modalCustomContent .message { background: var(--bg); border-radius: 8px; padding: 10px; opacity: 1; transform: none; pointer-events: none; }
			/* DEFINITIVE SETTINGS SECTIONS LAYOUT (FINAL) */
			.settings-section { /* Base style for all sections */ }
			.settings-section:first-of-type {
				margin-top: 0; padding-top: 0; border-top: none;
			}
			.settings-section + .settings-section {
				margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--card);
			}
			.settings-section h4 { margin: 0 0 10px 0; color: var(--muted); }
			.settings-section input { width: 95%; padding: 8px; margin-bottom: 8px; border-radius: 5px; border: none; background: var(--input-bg); color: var(--text); }
			.settings-section button { padding: 8px 12px; border-radius: 5px; border: none; background: var(--accent); color: white; cursor: pointer; }
			.settings-section .btn-danger { background-image: linear-gradient(to top, #c0392b 0%, #e74c3c 100%); }
			/* IMPROVED SETTINGS STATUS MESSAGE */
			#settingsStatus {
				font-weight: bold; font-size: 12px; transition: all 0.3s ease;
			}
			#settingsStatus.success, #settingsStatus.error {
				margin-top: 10px; margin-bottom: 5px; min-height: 16px;
			}
			#settingsStatus.success { color: #2ecc71; }
			#settingsStatus.error { color: #e74c3c; }
			
			/* --- REPLIES, FORWARDS, MENTIONS --- */
			#replyPreview { display: none; padding: 8px 12px; background: var(--panel); border-top: 1px solid var(--card); font-size: 13px; color: var(--muted); }
			#replyPreview .reply-text { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 80%; display: inline-block; }
			#replyPreview strong { color: var(--text); }
			#cancelReplyBtn { float: right; cursor: pointer; font-weight: bold; font-size: 16px; padding: 0 5px; }
			.reply-quote { background: var(--bg); border-left: 3px solid var(--accent); padding: 4px 8px; margin-bottom: 4px; font-size: 13px; border-radius: 4px; color: var(--muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: pointer; }
			.reply-quote:hover { background: var(--card); }
			.forward-channel-list { max-height: 200px; overflow-y: auto; border: 1px solid var(--card); border-radius: 5px; padding: 5px; display: flex; flex-direction: column; gap: 4px; }
			.forward-channel-item { display: block; padding: 8px; border-radius: 5px; cursor: pointer; }
			.forward-channel-item:hover { background: var(--card-hover); }
			.forward-channel-item input { margin-right: 8px; }
			.mention-highlight { background-color: hsla(235, 85%, 65%, 0.3); color: #c1cef8; font-weight: 700; padding: 1px 3px; border-radius: 3px; }
			.mention-highlight.me { background-color: var(--accent); color: white; }
			
			/* --- NOTIFICATIONS --- */
			#notifBtn { position: relative; }
			#notifBtn .badge {
				position: absolute; top: -5px; right: -5px; padding: 1px 5px;
				font-size: 10px; transform: scale(0); transition: transform 0.2s ease-in-out;
			}
			#notifBtn .badge.show { transform: scale(1); }
			.notification-list { max-height: 300px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
			.notification-item { padding: 10px; background: var(--card); border-radius: 6px; cursor: pointer; border-left: 3px solid transparent; transition: all 0.2s ease; }
			.notification-item:hover { background: var(--card-hover); }
			.notification-item.unread { border-left-color: var(--accent); }
			.notification-meta { font-size: 12px; color: var(--muted); margin-bottom: 4px; }
			.notification-text { font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
			
			/* --- AUTH VALIDATION & REQUIREMENTS --- */
			#authMessage.error { color: #e74c3c; font-weight: 600; text-align: center; font-size: 14px; margin-top: 5px; }
			.input-error { border: 1px solid #e74c3c !important; animation: shake 0.6s cubic-bezier(.36,.07,.19,.97) both; }
			#passwordRequirements { display: none; flex-direction: column; gap: 6px; margin-top: 8px; padding: 10px; background: var(--input-bg); border-radius: 8px; font-size: 13px; transition: all 0.3s ease; }
			.requirement { display: flex; align-items: center; gap: 8px; color: var(--muted); transition: color 0.3s ease; }
			.requirement .checkbox { display: flex; align-items: center; justify-content: center; width: 16px; height: 16px; border: 2px solid var(--muted); border-radius: 50%; font-weight: bold; color: white; transition: all 0.3s ease; transform: scale(0); }
			.requirement.valid { color: #2ecc71; }
			.requirement.valid .checkbox { background-color: #2ecc71; border-color: #2ecc71; transform: scale(1); }
			
			/* --- CREDITS & BROWSE DIALOG --- */
			.credit-item { font-size: 14px; color: var(--muted); margin-bottom: 8px; }
			.credit-item strong { color: var(--text); font-weight: 600; }
			.credit-item a { color: var(--accent); text-decoration: none; font-weight: 600; }
			.credit-item a:hover { text-decoration: underline; }
			.browse-channel-list { max-height: 200px; overflow-y: auto; border: 1px solid var(--card); border-radius: 5px; padding: 5px; display: flex; flex-direction: column; gap: 4px; margin-bottom: 10px; }
			.browse-channel-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-radius: 5px; }
			.browse-channel-item:hover { background: var(--card-hover); }
			/* UPGRADED BROWSE DIALOG BUTTONS */
			.browse-channel-item button {
				padding: 6px 10px; font-size: 12px; font-weight: 700; border: none; border-radius: 6px;
				color: white; cursor: pointer;
				background-image: linear-gradient(to top, var(--accent) 0%, #8ea4eb 100%);
				box-shadow: 0 1px 3px rgba(0,0,0,0.2), inset 0 1px 1px rgba(255,255,255,0.1);
				transition: all 0.2s ease-in-out; text-shadow: 0 1px 1px rgba(0,0,0,0.2);
			}
			.browse-channel-item button:not(:disabled):hover {
				transform: translateY(-1px);
				box-shadow: 0 2px 5px rgba(0,0,0,0.3), inset 0 1px 1px rgba(255,255,255,0.1);
				filter: brightness(1.1);
			}
			.browse-channel-item button:not(:disabled):active {
				transform: translateY(0px);
				box-shadow: 0 1px 1px rgba(0,0,0,0.4), inset 0 1px 1px rgba(0,0,0,0.2);
				filter: brightness(0.95);
			}
			.browse-channel-item button:disabled {
				background-image: none; background-color: #5c636a; box-shadow: none;
				color: var(--muted); cursor: not-allowed; opacity: 0.6;
			}
			
			/* --- ACTION ICONS (CLOSE/DELETE) --- */
			.close-dm-btn {
				font-size: 14px; padding: 2px 4px; line-height: 1; border-radius: 50%;
				opacity: 0; cursor: pointer; transition: all 0.2s ease;
			}
			.deleteBtn {
				opacity: 0; cursor: pointer; transition: all 0.2s ease;
			}
			.channelRow:hover .close-dm-btn, .channelRow:hover .deleteBtn {
				opacity: 0.7;
			}
			.close-dm-btn:hover, .deleteBtn:hover {
				opacity: 1; background-color: rgba(0,0,0, 0.2); transform: scale(1.15);
			}
			
			/* --- ANIMATIONS & MEDIA QUERIES --- */
			@keyframes shake {
				10%, 90% { transform: translate3d(-1px, 0, 0); }
				20%, 80% { transform: translate3d(2px, 0, 0); }
				30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
				40%, 60% { transform: translate3d(4px, 0, 0); }
			}
			@media (max-width:1000px){ #rightbar{display:none} #sidebar{width:220px} }
		</style>
	</head>
	<body>
		<!-- AUTH -->
		<div id="authDiv">
			<div class="authCard">
				<div style="display:flex; align-items:center; justify-content:space-between;">
					<div class="authTabs" role="tablist">
						<button id="loginTab" class="active" onclick="switchAuth('login')">Login</button>
						<button id="signupTab" onclick="switchAuth('signup')">Sign Up</button>
					</div>
					<div style="display:flex; gap:8px;">
						<button class="tinyBtn" id="themeBtn" title="Toggle theme" onclick="toggleTheme()">🌙</button>
						<button class="tinyBtn" id="viewBtn" title="Toggle compact/cozy" onclick="toggleView()">🛋️</button>
					</div>
				</div>
				<input id="authUsername" placeholder="Username" />
				<input id="authPassword" placeholder="Password" type="password" />
				<input id="authConfirm" placeholder="Confirm Password" type="password" style="display:none" />
				<div id="passwordRequirements" style="display: none;">
					<div id="req-length" class="requirement"><span class="checkbox">✓</span> <span class="text">At least 8 characters</span></div>
					<div id="req-uppercase" class="requirement"><span class="checkbox">✓</span> <span class="text">One uppercase letter</span></div>
					<div id="req-lowercase" class="requirement"><span class="checkbox">✓</span> <span class="text">One lowercase letter</span></div>
					<div id="req-number" class="requirement"><span class="checkbox">✓</span> <span class="text">One number</span></div>
				</div>
				<button id="submitBtn" onclick="submitAuth()">Login</button>
				<div id="authMessage"></div>
			</div>
		</div>
		<!-- APP -->
		<div id="app" style="display: none;">
			<div id="sidebar">
				<div id="sidebarHeader">
					<div>Channels</div>
					<div class="controls">
						<button id="notifBtn" class="tinyBtn" onclick="showNotificationsModal()" title="Notifications">🔔 <div class="badge" id="notifBadge"></div></button>
						<button id="myStatusBtn" class="tinyBtn" onclick="cycleStatus()" title="Click to change your status">●</button>
						<button id="settingsBtn" class="tinyBtn" onclick="showSettingsModal()" title="Settings">⚙️</button>
						<button id="logoutBtn" class="tinyBtn" onclick="logout()" title="Logout">🚪</button>
						<div id="meLabel" style="font-size:12px;color:var(--muted)"></div>
					</div>
				</div>
				<div id="channelList"></div>
				<div class="sidebarButtons">
					<button onclick="showBrowseDialog()">Browse / Create</button>
				</div>
			</div>
			<div id="main">
				<div id="chatHeader">
					<div id="chatTitle">No channel selected</div>
					<div class="meta">
						<div id="channelInfo"></div>
						<div id="dmHint" style="color:var(--muted)"></div>
					</div>
				</div>
				<div style="display:flex; flex:1; gap:12px; min-height:0;">
					<div id="messages" style="flex:1;"></div>
					<div id="rightbar">
						<div id="usersHeader">
							<div>Users</div>
							<div style="font-size:12px;color:var(--muted)">Click to DM</div>
						</div>
						<div id="userList" style="overflow:auto; display:flex; flex-direction:column; gap:6px;"></div>
					</div>
				</div>
				<div id="replyPreview">
					<span id="cancelReplyBtn" onclick="cancelReply()">×</span>
					Replying to <strong id="replyUser"></strong>: <span id="replyText" class="reply-text"></span>
				</div>
				<div id="bottomBar">
					<input id="msgInput" placeholder="Type a message..." onkeydown="if(event.key==='Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); }" />
					<button id="sendBtn" onclick="sendMessage()">Send</button>
				</div>
			</div>
		</div>
		<button id="scrollBtn">↓</button>
		<!-- MODAL -->
		<div id="modalOverlay">
			<div class="modalCard">
				<h3 id="modalTitle">Modal</h3>
				<div id="modalSubtitle" class="modal-subtitle"></div>
				<div id="modalCustomContent"></div>
				<input id="modalInput" autocomplete="off" />
				<div class="modalActions">
					<button id="modalConfirmBtn" onclick="submitModal()">OK</button>
					<button id="modalCancelBtn" onclick="closeModal()">Cancel</button>
				</div>
			</div>
		</div>

		<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
		<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
		<script>
			/* ============================ Firebase config — REPLACE ============================ */
			const firebaseConfig = {
                //fill later
            };
			firebase.initializeApp(firebaseConfig);
			const db = firebase.database();

			/* ============================ App State ============================ */
			let username = "";
			let currentChannel = "";
			let modalCallback = null;
			let authMode = "login";
			const unread = {}; 
			let autoScroll = true;
			let myStatus = "online";
			let compactView = false;
			let lightTheme = false;
			let replyingToId = null;
			let userSettings = { desktopNotifications: true }; // Default to enabled
			let lastMessageMeta = {user:null, ts: 0};
			
			/* ============================ Utilities ============================ */
			function uidColor(name){
				if (!name) return "#7289da";
				const palette=["#e67e22","#e74c3c","#9b59b6","#16a085","#f39c12","#3498db","#2ecc71","#d35400","#1abc9c","#8e44ad"];
				let h=0; for(let i=0;i<name.length;i++) h=(h<<5)-h+name.charCodeAt(i); h=Math.abs(h);
				return palette[h % palette.length];
			}
			function initials(name){ return name ? name.trim().charAt(0).toUpperCase() : "?"; }
			function nowHHMM(ts){
				const d = ts ? new Date(ts) : new Date();
				return `${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`;
			}
			function generateAvatarUrl(user) {
				const canvas=document.createElement('canvas'); canvas.width=128; canvas.height=128;
				const ctx=canvas.getContext('2d');
				ctx.fillStyle=uidColor(user); ctx.fillRect(0,0,128,128);
				ctx.fillStyle='#FFFFFF'; ctx.font='bold 72px sans-serif';
				ctx.textAlign='center'; ctx.textBaseline='middle';
				ctx.fillText(initials(user),64,64);
				return canvas.toDataURL();
			}

			/* ============================ Theme & View toggles ============================ */
			function toggleTheme(){
				lightTheme = !lightTheme;
				document.documentElement.classList.toggle("light", lightTheme);
				document.getElementById("themeBtn").textContent = lightTheme ? "☀️" : "🌙";
			}
			function toggleView(){
				compactView = !compactView;
				document.body.classList.toggle("compact", compactView);
				document.body.classList.toggle("cozy", !compactView);
				document.getElementById("viewBtn").textContent = compactView ? "🪶" : "🛋️";
			}

			/* ============================ Auth & Logout ============================ */
			function switchAuth(mode){
				authMode=mode;
				document.getElementById("loginTab").classList.toggle("active",mode==="login");
				document.getElementById("signupTab").classList.toggle("active",mode==="signup");
				document.getElementById("authConfirm").style.display=(mode==="signup")?"block":"none";
				const reqs=document.getElementById("passwordRequirements");
				reqs.style.display=(mode==="signup")?"flex":"none";
				document.getElementById("submitBtn").textContent=(mode==="signup")?"Sign Up":"Login";
				document.getElementById("authMessage").textContent="";
			}
			function submitAuth(){
				const unameInput=document.getElementById("authUsername");
				const pwdInput=document.getElementById("authPassword");
				const confInput=document.getElementById("authConfirm");
				const messageEl=document.getElementById("authMessage");
				const setAuthError=(message,fields)=>{
					messageEl.textContent=message; messageEl.className='error';
					[unameInput,pwdInput,confInput].forEach(el=>el.classList.remove('input-error'));
					if(fields)fields.forEach(el=>el.classList.add('input-error'));
				};
				messageEl.textContent=''; messageEl.className='';
				const uname=unameInput.value.trim();
				const pwd=pwdInput.value.trim();
				const conf=confInput.value.trim();
				if(authMode==="login"){
					if(!uname||!pwd)return setAuthError("Please enter both username and password.",[!uname?unameInput:null,!pwd?pwdInput:null].filter(Boolean));
					db.ref("users/"+uname).once("value").then(snap=>{
						snap.exists()&&snap.val().password===pwd?(username=uname,afterLogin()):setAuthError("Invalid username or password.",[unameInput,pwdInput]);
					});
				}else{
					if(!uname||!pwd||!conf)return setAuthError("Please fill out all fields.",[!uname?unameInput:null,!pwd?pwdInput:null,!conf?confInput:null].filter(Boolean));
					if(uname.length<3)return setAuthError("Username must be at least 3 characters.",[unameInput]);
					if(!/^[a-zA-Z0-9_]+$/.test(uname))return setAuthError("Username can only contain letters, numbers, and underscores.",[unameInput]);
					if(pwd.length<8||!/[A-Z]/.test(pwd)||!/[a-z]/.test(pwd)||!/[0-9]/.test(pwd)){
						return setAuthError("Password does not meet all requirements.",[pwdInput,confInput]);
					}
					if(pwd!==conf)return setAuthError("Passwords do not match.",[pwdInput,confInput]);
					db.ref("users/"+uname).once("value").then(snap=>{
						snap.exists()?setAuthError("That username is already taken.",[unameInput]):(db.ref("users/"+uname).set({password:pwd}),username=uname,afterLogin());
					});
				}
			}
			function afterLogin(){
				document.getElementById("authDiv").style.display="none";
				document.getElementById("app").style.display="flex";
				document.getElementById("meLabel").textContent=username+" • "+myStatus;
				if('Notification'in window){Notification.requestPermission();}
				db.ref(`users/${username}`).on('value',snap=>{
					if(snap.exists()&&snap.val().settings){userSettings=snap.val().settings;}
					else{userSettings={desktopNotifications:true};}
				});
				startPresence();
				loadChannels();
				attachGlobalMessageWatcher();
				attachMessageScrollHandler();
				loadUserListPeriodically();
				db.ref(`users/${username}/notifications`).on('value',snap=>{
					let unreadCount=0;
					if(snap.exists()){snap.forEach(child=>{if(child.val().read===false)unreadCount++;});}
					const badge=document.getElementById('notifBadge');
					badge.textContent=unreadCount>9?'9+':unreadCount;
					badge.classList.toggle('show',unreadCount>0);
				});
			}
			function logout(){
				showModal("Logout","Are you sure you want to log out?",(confirmed)=>{
					if(confirmed)window.location.reload();
					closeModal();
				},{showInput:false,confirmText:"Logout",danger:true});
			}

			/* ============================ Presence / status ============================ */
			function startPresence(){
				const ref=db.ref("presence/"+username);
				function write(status){
					ref.set({status:status,lastSeen:Date.now()});
					myStatus=status;
					document.getElementById("meLabel").textContent=username+" • "+myStatus;
					updateStatusButton();
					ref.onDisconnect().remove();
				}
				write("online");
				window.addEventListener("beforeunload",()=>{ref.set({status:"offline",lastSeen:Date.now()});});
			}
			function cycleStatus(){
				if(myStatus==="online")myStatus="away";
				else if(myStatus==="away")myStatus="offline";
				else myStatus="online";
				db.ref("presence/"+username).set({status:myStatus,lastSeen:Date.now()});
				document.getElementById("meLabel").textContent=username+" • "+myStatus;
				updateStatusButton();
			}
			function updateStatusButton(){
				const btn=document.getElementById("myStatusBtn");
				if(myStatus==="online"){btn.style.color="#2ecc71";btn.textContent="●";}
				else if(myStatus==="away"){btn.style.color="#f1c40f";btn.textContent="●";}
				else{btn.style.color="#95a5a6";btn.textContent="●";}
			}

			/* ============================ Channels & DMs Management ============================ */
			async function loadChannels(){
				const userSnap=await db.ref(`users/${username}`).once('value');
				const hiddenChannels=userSnap.val()?.hiddenChannels||{};
				db.ref("channels").on("value",snap=>{
					const cl=document.getElementById("channelList");
					cl.innerHTML="";
					snap.forEach(ch=>{
						const name=ch.key;
						const data=ch.val()||{};
						if(data.type==="dm"){if(!data.members||!data.members[username]||data.members[username].active===false){return;}}
						else{if(hiddenChannels[name]){return;}}
						const createdBy=data.createdBy||"";
						const row=document.createElement("div");
						row.className="channelRow"+(name===currentChannel?" active":"");
						const left=document.createElement("div");left.className="channelLeft";
						const label=document.createElement("div");
						label.textContent=data.type==="dm"?dmLabelFor(name,data):"# "+name;
						label.style.fontWeight=800;left.appendChild(label);
						if(unread[name]&&unread[name]>0){const b=document.createElement("div");b.className="badge";b.textContent=unread[name]>9?"9+":unread[name];left.appendChild(b);}
						row.appendChild(left);
						if(data.type==="dm"){
							const closeBtn=document.createElement("div");closeBtn.className="close-dm-btn";
							closeBtn.innerHTML="❌";closeBtn.title="Close DM";
							closeBtn.onclick=(e)=>{e.stopPropagation();closeDM(name);};
							row.appendChild(closeBtn);
						}else{
							if(createdBy===username||username==="admin"){
								const del=document.createElement("button");del.textContent="🗑️";
								del.className="deleteBtn";del.onclick=(e)=>{e.stopPropagation();deleteChannel(name);};
								row.appendChild(del);
							}else{
								const hideBtn=document.createElement("div");hideBtn.className="close-dm-btn";
								hideBtn.innerHTML="❌";hideBtn.title="Hide Channel";
								hideBtn.onclick=(e)=>{e.stopPropagation();hideChannel(name);};
								row.appendChild(hideBtn);
							}
						}
						row.onclick=()=>joinChannel(name);
						cl.appendChild(row);
					});
				});
			}
			function dmLabelFor(name,data){
				if(!data||!data.members)return"DM";
				const members=Object.keys(data.members);
				const other=members.find(m=>m!==username);
				return other?("@"+other):name;
			}
			function createChannel(name){
				if(!name)return;
				db.ref("channels/"+name).once("value").then(snap=>{
					if(snap.exists()){return;}
					db.ref("channels/"+name).set({createdBy:username,type:"public"});
					joinChannel(name);
				});
			}
			function createDMWith(otherUser){
				if(!otherUser||otherUser===username)return;
				const members=[username,otherUser].sort();
				const dmName="dm__"+members.join("__");
				db.ref("channels/"+dmName).once("value").then(snap=>{
					if(!snap.exists()){
						const membersObj={};
						membersObj[members[0]]={active:true};membersObj[members[1]]={active:true};
						db.ref("channels/"+dmName).set({type:"dm",members:membersObj,createdBy:username});
					}else{
						const updates={};
						updates[`/channels/${dmName}/members/${members[0]}/active`]=true;
						updates[`/channels/${dmName}/members/${members[1]}/active`]=true;
						db.ref().update(updates);
					}
					joinChannel(dmName);
				});
			}
			function deleteChannel(name){
				db.ref("channels/"+name).remove();db.ref("messages/"+name).remove();
				delete unread[name];
				if(currentChannel===name){
					currentChannel="";
					document.getElementById("messages").innerHTML="";
					document.getElementById("chatHeader").textContent="No channel selected";
				}
				loadChannels();
			}
			function closeDM(channelId){
				if(channelId===currentChannel){
					currentChannel="";
					document.getElementById("messages").innerHTML="";
					document.getElementById("chatTitle").textContent="No channel selected";
					document.getElementById("msgInput").placeholder="Type a message...";
					cancelReply();
				}
				db.ref(`channels/${channelId}/members/${username}`).update({active:false});
			}
			async function hideChannel(channelId){
				if(channelId===currentChannel){
					currentChannel="";
					document.getElementById("messages").innerHTML="";
					document.getElementById("chatTitle").textContent="No channel selected";
					document.getElementById("msgInput").placeholder="Type a message...";
					cancelReply();
				}
				await db.ref(`users/${username}/hiddenChannels/${channelId}`).set(true);
				await loadChannels();
			}
			async function unhideChannel(channelId,buttonElement){
				await db.ref(`users/${username}/hiddenChannels/${channelId}`).remove();
				buttonElement.textContent="Shown!";
				buttonElement.disabled=true;
				await loadChannels();
			}

			/* ============================ Joining Channels & Loading Messages ============================ */
			async function joinChannel(name){
				if(!name||name===currentChannel)return;
				if(currentChannel){db.ref("messages/"+currentChannel).off();}
				currentChannel=name;
				cancelReply();
				unread[name]=0;
				updateChannelBadges();
				lastMessageMeta={user:null,ts:0};
				const messagesDiv=document.getElementById("messages");
				messagesDiv.innerHTML="";
				const channelSnap=await db.ref("channels/"+name).once("value");
				const data=channelSnap.val()||{};
				const title=(data.type==="dm")?dmLabelFor(name,data):("# "+name);
				document.getElementById("chatTitle").textContent=title;
				const messagesSnap=await db.ref("messages/"+name).once("value");
				if(messagesSnap.exists()){
					const messagesData=messagesSnap.val();
					for(const key in messagesData){await appendMessage(messagesData[key],key);}
				}
				autoScroll=true;
				messagesDiv.scrollTop=messagesDiv.scrollHeight;
				db.ref("messages/"+name).limitToLast(1).on("child_added",(snap2,prevChildKey)=>{
					if(Object.keys(messagesSnap.val()||{}).includes(snap2.key))return;
					appendMessage(snap2.val(),snap2.key);
				});
				db.ref("messages/"+name).on("child_removed",snap2=>{
					const el=document.querySelector(`.message[data-id="${snap2.key}"]`);if(el)el.remove();
				});
				db.ref("messages/"+name).on("child_changed",snap2=>{
					const m=snap2.val(),msgEl=document.querySelector(`.message[data-id="${snap2.key}"]`);
					if(msgEl){
						msgEl.querySelector('.msgText').innerHTML=parseMentions(m.text);
						let indicator=msgEl.querySelector('.edited-indicator');
						if(m.edited&&!indicator){
							indicator=document.createElement('span');indicator.className='edited-indicator';
							indicator.textContent='(edited)';msgEl.querySelector('.timestamp').appendChild(indicator);
						}
					}
				});
				const msgInput=document.getElementById("msgInput");
				msgInput.placeholder=(data.type==="dm")?`Message @${Object.keys(data.members).find(u=>u!==username)||"DM"}`:`Message #${name}`;
			}
			
			/* ============================ Messages ============================ */
			function parseMentions(text){
				if(!text)return"";
				let safeText=text.replace(/</g,"&lt;").replace(/>/g,"&gt;");
				safeText=safeText.replace(/\*(.*?)\*/g,'<strong>$1</strong>').replace(/_(.*?)_/g,'<em>$1</em>');
				safeText=safeText.replace(/@([a-zA-Z0-9_]+)/g,(match,mentionedUser)=>{
					const isMe=mentionedUser===username;
					return`<span class="mention-highlight ${isMe?'me':''}" data-user="${mentionedUser}">${match}</span>`;
				});
				return safeText;
			}
			async function appendMessage(m,id){
				const{user,text,ts,edited,replyingTo}=m;
				const messages=document.getElementById("messages");
				const within=lastMessageMeta&&((ts||Date.now())-lastMessageMeta.ts)<(5*60*1000);
				const grouped=lastMessageMeta.user===user&&within&&!replyingTo;
				if(grouped&&messages.lastElementChild){
					const content=document.createElement("div");
					content.className="msgText";content.innerHTML=parseMentions(text);
					messages.lastElementChild.querySelector(".msgBody").appendChild(content);
					lastMessageMeta.ts=ts||Date.now();
					if(autoScroll)messages.scrollTop=messages.scrollHeight;
					return;
				}
				const msg=document.createElement("div");msg.className="message";msg.dataset.id=id;
				const av=document.createElement("div");av.className="avatar";
				av.style.background=uidColor(user);av.textContent=initials(user);
				const body=document.createElement("div");body.className="msgBody";
				if(replyingTo){
					const repliedMsgSnap=await db.ref(`messages/${currentChannel}/${replyingTo}`).once('value');
					if(repliedMsgSnap.exists()){
						const repliedMsgData=repliedMsgSnap.val();
						const quote=document.createElement('div');quote.className='reply-quote';
						quote.innerHTML=`<strong style="color:${uidColor(repliedMsgData.user)}">@${repliedMsgData.user}</strong>: ${parseMentions(repliedMsgData.text)}`;
						quote.onclick=()=>{
							const original=document.querySelector(`.message[data-id="${replyingTo}"]`);
							if(original)original.scrollIntoView({behavior:'smooth',block:'center'});
						};
						body.appendChild(quote);
					}
				}
				const head=document.createElement("div");head.className="msgHeader";
				const nameEl=document.createElement("span");nameEl.className="username";
				nameEl.style.color=uidColor(user);nameEl.textContent=user;
				const timeEl=document.createElement("span");timeEl.className="timestamp";
				timeEl.textContent=nowHHMM(ts);
				if(edited){const indicator=document.createElement('span');indicator.className='edited-indicator';indicator.textContent='(edited)';timeEl.appendChild(indicator);}
				head.appendChild(nameEl);head.appendChild(timeEl);
				const content=document.createElement("div");content.className="msgText";
				content.innerHTML=parseMentions(text);
				body.appendChild(head);body.appendChild(content);
				msg.appendChild(av);msg.appendChild(body);
				if(user==="System"||user==="admin")msg.classList.add("system");
				const menu=document.createElement("div");menu.className="message-menu";
				const replyItem=document.createElement("div");replyItem.className="menu-item";
				replyItem.textContent="↪️";replyItem.title="Reply";replyItem.onclick=()=>showReplyUI(id);
				const forwardItem=document.createElement("div");forwardItem.className="menu-item";
				forwardItem.textContent="➤";forwardItem.title="Forward";forwardItem.onclick=()=>showForwardUI(id);
				menu.appendChild(replyItem);menu.appendChild(forwardItem);
				if(user===username){
					const editItem=document.createElement("div");editItem.className="menu-item";
					editItem.textContent="✏️";editItem.title="Edit";editItem.onclick=()=>showEditUI(id);
					const deleteItem=document.createElement("div");deleteItem.className="menu-item";
					deleteItem.textContent="🗑️";deleteItem.title="Delete";deleteItem.onclick=(event)=>deleteMessage(id,event);
					menu.appendChild(editItem);menu.appendChild(deleteItem);
				}
				msg.appendChild(menu);
				messages.appendChild(msg);
				setTimeout(()=>msg.classList.add("show"),30);
				if(autoScroll)messages.scrollTop=messages.scrollHeight;
				lastMessageMeta={user,ts:ts||Date.now()};
			}
			async function attachGlobalMessageWatcher(){
				db.ref("messages").on("child_added",channelSnap=>{
					const channelName=channelSnap.key;
					db.ref("messages/"+channelName).limitToLast(1).on("child_added",async(snap)=>{
						const m=snap.val();
						if(m&&channelName!==currentChannel&&m.user!==username){
							const channelDataSnap=await db.ref(`channels/${channelName}`).once('value');
							if(channelDataSnap.exists()){
								const channelData=channelDataSnap.val();
								if(channelData.type==='dm'&&channelData.members&&channelData.members[username]&&channelData.members[username].active===false){
									db.ref(`channels/${channelName}/members/${username}`).update({active:true});
								}
							}
							unread[channelName]=(unread[channelName]||0)+1;
							updateChannelBadges();
						}
					});
				});
			}
			function updateChannelBadges(){loadChannels();}

			/* ============================ Reply and Forward Functions ============================ */
			function showReplyUI(messageId){
				const msgElement=document.querySelector(`.message[data-id="${messageId}"]`);
				if(!msgElement)return;
				replyingToId=messageId;
				const user=msgElement.querySelector('.username').textContent;
				const text=msgElement.querySelector('.msgText').textContent;
				document.getElementById('replyUser').textContent=user;
				document.getElementById('replyText').textContent=text;
				document.getElementById('replyPreview').style.display='block';
				document.getElementById('msgInput').focus();
			}
			function cancelReply(){
				replyingToId=null;
				document.getElementById('replyPreview').style.display='none';
			}
			async function showForwardUI(messageId){
				const channelsSnap=await db.ref('channels').once('value');
				const channelList=[];
				channelsSnap.forEach(snap=>{
					const data=snap.val();
					if(data.type!=='dm'||(data.members&&data.members[username])){
						channelList.push({id:snap.key,data:data});
					}
				});
				const listHTML=channelList.map(ch=>`
					<label class="forward-channel-item">
						<input type="checkbox" name="forwardChannel" value="${ch.id}">
						${ch.data.type==='dm'?dmLabelFor(ch.id,ch.data):'# '+ch.id}
					</label>
				`).join('');
				const forwarderHTML=document.createElement('div');
				forwarderHTML.innerHTML=`<div class="forward-channel-list">${listHTML}</div>`;
				showModal('Forward Message To...',"Select one or more destinations:",(confirmed)=>{
					if(confirmed){
						const selected=document.querySelectorAll('input[name="forwardChannel"]:checked');
						const targetChannels=Array.from(selected).map(el=>el.value);
						if(targetChannels.length>0)forwardMessage(messageId,targetChannels);
					}
					closeModal();
				},{showInput:false,customHTML:forwarderHTML,confirmText:'Forward'});
			}
			async function forwardMessage(messageId,targetChannels){
				const messageSnap=await db.ref(`messages/${currentChannel}/${messageId}`).once('value');
				if(!messageSnap.exists())return;
				const originalMessage=messageSnap.val();
				const forwardText=`[Forwarded from @${originalMessage.user}]: ${originalMessage.text}`;
				targetChannels.forEach(channelId=>{
					const payload={user:username,text:forwardText,ts:Date.now()};
					db.ref(`messages/${channelId}`).push(payload);
				});
			}

			/* ============================ Edit & Delete Functions ============================ */
			function deleteMessage(messageId,event){
				if(!currentChannel||!messageId)return;
				if(event&&event.shiftKey){db.ref(`messages/${currentChannel}/${messageId}`).remove();return;}
				const originalMsgElement=document.querySelector(`.message[data-id="${messageId}"]`);
				if(!originalMsgElement)return;
				const previewElement=originalMsgElement.cloneNode(true);
				previewElement.querySelector('.message-menu')?.remove();
				previewElement.classList.add('modal-preview');
				showModal("Delete Message","Are you sure you want to delete this message?",
					(c)=>{if(c)db.ref(`messages/${currentChannel}/${messageId}`).remove();closeModal();},
					{showInput:false,customHTML:previewElement,confirmText:"Delete",danger:true}
				);
			}
			function showEditUI(messageId){
				cancelAllEdits();
				const msgElement=document.querySelector(`.message[data-id="${messageId}"]`);
				if(!msgElement)return;
				const msgTextElement=msgElement.querySelector(".msgText");
				const originalText=msgTextElement.textContent;
				const editInput=document.createElement("textarea");
				editInput.className="edit-input";editInput.value=originalText;
				editInput.rows=Math.min(10,Math.ceil(originalText.length/50));
				const helperText=document.createElement("div");
				helperText.className="edit-helper-text";
				helperText.innerHTML="press <strong>Esc</strong> to cancel • <strong>Enter</strong> to save";
				editInput.onkeydown=(event)=>{
					if(event.key==="Enter"&&!event.shiftKey){event.preventDefault();saveEdit(messageId,editInput.value);}
					if(event.key==="Escape")cancelAllEdits();
				};
				msgTextElement.style.display="none";
				msgTextElement.parentElement.appendChild(editInput);
				msgTextElement.parentElement.appendChild(helperText);
				editInput.focus();
			}
			function saveEdit(messageId,newText){
				if(!currentChannel||!messageId||!newText.trim()){cancelAllEdits();return;}
				db.ref(`messages/${currentChannel}/${messageId}`).update({text:newText.trim(),edited:true})
					.catch(error=>console.error("Error saving edit:",error));
				cancelAllEdits();
			}
			function cancelAllEdits(){
				document.querySelectorAll('textarea.edit-input').forEach(input=>{
					const msgBody=input.parentElement;
					if(msgBody){
						const helper=msgBody.querySelector('.edit-helper-text');if(helper)helper.remove();
						input.remove();
						const originalText=msgBody.querySelector('.msgText');if(originalText)originalText.style.display='block';
					}
				});
			}

			/* ============================ User list ============================ */
			function loadUserList(){
				const userList=document.getElementById("userList");
				userList.innerHTML="";
				db.ref("presence").once("value").then(snap=>{
					const items=[];
					snap.forEach(ch=>items.push({name:ch.key,data:ch.val()}));
					db.ref("users").once("value").then(usnap=>{
						usnap.forEach(u=>{if(!items.find(it=>it.name===u.key))items.push({name:u.key,data:{status:"offline"}});});
						items.sort((a,b)=>{
							const order={online:0,away:1,offline:2};
							return(order[a.data.status||"offline"]-order[b.data.status||"offline"])||a.name.localeCompare(b.name);
						});
						items.forEach(it=>{
							const row=document.createElement("div");row.className="userRow";
							const dot=document.createElement("div");
							dot.className=`statusDot status-${it.data.status||'offline'}`;
							const av=document.createElement("div");av.className="avatar";
							av.style.background=uidColor(it.name);av.style.width="34px";av.style.height="34px";av.textContent=initials(it.name);
							const name=document.createElement("div");name.className="userName";name.textContent=it.name;
							const meta=document.createElement("div");meta.style.marginLeft="auto";meta.style.fontSize="12px";meta.style.color="var(--muted)";
							if(it.data.lastSeen)meta.textContent=(it.data.status==="online"?"online":("last: "+nowHHMM(it.data.lastSeen)));
							row.appendChild(av);row.appendChild(name);row.appendChild(dot);row.appendChild(meta);
							row.onclick=()=>createDMWith(it.name);
							userList.appendChild(row);
						});
					});
				});
			}
			function loadUserListPeriodically(){loadUserList();setInterval(loadUserList,5000);}

			/* ============================ Scroll handler ============================ */
			function attachMessageScrollHandler(){
				const messagesDiv=document.getElementById("messages"),scrollBtn=document.getElementById("scrollBtn");
				messagesDiv.addEventListener("scroll",()=>{
					const atBottom=(messagesDiv.scrollTop+messagesDiv.clientHeight)>=(messagesDiv.scrollHeight-60);
					autoScroll=atBottom;
					scrollBtn.classList.toggle("show",!atBottom);
				});
				scrollBtn.onclick=()=>{
					messagesDiv.scrollTop=messagesDiv.scrollHeight;scrollBtn.classList.remove("show");autoScroll=true;
				};
			}

			/* ============================ Sending messages + commands ============================ */
			async function sendMessage(){
				const input=document.getElementById("msgInput");let text=input.value.trim();
				if(!text||!currentChannel)return;
				const payload={user:username,text:text,ts:Date.now()};
				if(replyingToId)payload.replyingTo=replyingToId;
				const newMessageRef=db.ref("messages/"+currentChannel).push();
				await newMessageRef.set(payload);
				const mentions=text.match(/@([a-zA-Z0-9_]+)/g);
				if(mentions){
					const uniqueMentions=[...new Set(mentions.map(m=>m.substring(1)))];
					uniqueMentions.forEach(async(mentionedUser)=>{
						if(mentionedUser===username)return;
						const userSnap=await db.ref(`users/${mentionedUser}`).once('value');
						if(userSnap.exists()){
							const messageId=newMessageRef.key;
							const notifPayload={
								type:'mention',from:username,channel:currentChannel,
								messageId:messageId,text:text.substring(0,100),
								read:false,ts:Date.now()
							};
							db.ref(`users/${mentionedUser}/notifications`).push(notifPayload);
							if(userSettings.desktopNotifications&&document.hidden&&'Notification'in window&&Notification.permission==='granted'){
								const title=`New mention from @${username}`;
								const options={body:text,icon:generateAvatarUrl(username),tag:messageId};
								const notification=new Notification(title,options);
								notification.onclick=()=>{window.focus();goToMention(currentChannel,messageId,null);};
							}
						}
					});
				}
				input.value="";
				cancelReply();
			}

			/* ============================ Notifications Modal & Logic ============================ */
			async function showNotificationsModal(){
				const notifsSnap=await db.ref(`users/${username}/notifications`).orderByChild('ts').once('value');
				const notifList=[];
				if(notifsSnap.exists()){notifsSnap.forEach(snap=>{notifList.push({id:snap.key,...snap.val()});});}
				notifList.reverse();
				const listHTML=notifList.length>0?notifList.map(n=>`
					<div class="notification-item ${!n.read?'unread':''}" onclick="goToMention('${n.channel}','${n.messageId}','${n.id}')">
						<div class="notification-meta">
							<strong>@${n.from}</strong> mentioned you in <strong>#${n.channel.startsWith('dm__')?'a DM':n.channel}</strong>
						</div>
						<div class="notification-text">${n.text}</div>
					</div>`).join(''):'<div style="text-align:center; padding: 20px; color:var(--muted);">No notifications yet.</div>';
				const customHTML=document.createElement('div');
				customHTML.innerHTML=`<div class="notification-list">${listHTML}</div>`;
				showModal("Notifications","Click a notification to jump to the message.",
					()=>{markAllAsRead();closeModal();},
					{showInput:false,customHTML,confirmText:'Mark All as Read & Close'}
				);
			}
			async function goToMention(channelId,messageId,notifId){
				if(notifId)db.ref(`users/${username}/notifications/${notifId}`).update({read:true});
				closeModal();
				await joinChannel(channelId);
				setTimeout(()=>{
					const msgEl=document.querySelector(`.message[data-id="${messageId}"]`);
					if(msgEl){
						msgEl.scrollIntoView({behavior:'smooth',block:'center'});
						msgEl.style.transition='none';
						msgEl.style.backgroundColor='var(--accent)';
						setTimeout(()=>{
							msgEl.style.transition='background-color 0.5s ease';
							msgEl.style.backgroundColor='';
						},1500);
					}
				},500);
			}
			function markAllAsRead(){
				db.ref(`users/${username}/notifications`).orderByChild('read').equalTo(false).once('value',snap=>{
					if(snap.exists()){
						const updates={};
						snap.forEach(child=>{updates[child.key+'/read']=true;});
						db.ref(`users/${username}/notifications`).update(updates);
					}
				});
			}

			/* ============================ Modal & Settings Functions ============================ */
			function showModal(title,subtitle,callback,options={}){
				modalCallback=callback;
				document.getElementById("modalTitle").textContent=title;
				const sub=document.getElementById("modalSubtitle");
				sub.textContent=subtitle;sub.style.display=subtitle?'block':'none';sub.style.color='var(--muted)';
				const custom=document.getElementById("modalCustomContent");custom.innerHTML='';
				if(options.customHTML)custom.appendChild(options.customHTML);
				const input=document.getElementById("modalInput");
				input.style.display=(options.showInput===false)?'none':'block';
				input.value="";input.placeholder=options.placeholder||"";
				const confirmBtn=document.getElementById("modalConfirmBtn");
				confirmBtn.textContent=options.confirmText||"OK";
				confirmBtn.style.background=options.danger?'#e74c3c':'var(--accent)';
				confirmBtn.style.display='inline-block';
				const cancelBtn=document.getElementById("modalCancelBtn");
				cancelBtn.style.display=options.hideCancel?'none':'inline-block';
				cancelBtn.textContent=options.cancelText||"Cancel";
				document.getElementById("modalOverlay").style.display="flex";
				if(options.showInput!==false)input.focus();
			}
			function closeModal(){
				document.getElementById("modalOverlay").style.display="none";
				document.getElementById("modalCustomContent").innerHTML='';
				modalCallback=null;
			}
			async function submitModal(){
				const input=document.getElementById("modalInput");
				const value=input.style.display!=='none'?input.value.trim():true;
				if(modalCallback)await modalCallback(value);
			}
			async function showBrowseDialog(){
				const channelsSnap=await db.ref('channels').once('value');
				const userSnap=await db.ref(`users/${username}`).once('value');
				const hiddenChannels=userSnap.val()?.hiddenChannels||{};
				const publicChannels=[];
				channelsSnap.forEach(snap=>{if(snap.val().type!=='dm'){publicChannels.push({id:snap.key,data:snap.val()});}});
				let listContentHTML='';
				if(publicChannels.length===0){
					listContentHTML=`<div style="text-align: center; padding: 20px; color: var(--muted);">
						There are no public channels yet. Why not create the first one?
					</div>`;
				}else{
					listContentHTML=publicChannels.map(channel=>{
						const isHidden=hiddenChannels[channel.id];
						return`
							<div class="browse-channel-item">
								<span># ${channel.id}</span>
								<button onclick="unhideChannel('${channel.id}', this)" ${!isHidden?'disabled':''}>
									${isHidden?'Show':'Joined'}
								</button>
							</div>`;
					}).join('');
				}
				const browserHTML=document.createElement('div');
				browserHTML.innerHTML=`
					<div class="browse-channel-list">${listContentHTML}</div>
					<hr style="border-color: var(--card); margin: 15px 0;">
					<p style="font-size: 14px; color: var(--muted); margin-top: 0;">Or, create a new one:</p>
				`;
				showModal("Browse & Create Channels","Here you can see all available channels or create a new one.",
					(newChannelName)=>{if(newChannelName){createChannel(newChannelName);}closeModal();},
					{customHTML:browserHTML,confirmText:"Create",placeholder:"new-channel-name"}
				);
			}
			function showSettingsModal(){
				const settingsHTML=`
					<div id="settingsStatus" class="settings-status"></div>
					<div class="settings-section"><h4>Appearance</h4>
						<button onclick="toggleThemeSetting()">Toggle Theme</button>
						<button onclick="toggleViewSetting()">Toggle View</button>
					</div>
					<div class="settings-section"><h4>Notifications</h4>
						<button id="notifToggleBtn" onclick="toggleDesktopNotifications()">
							Desktop Notifications: ${userSettings.desktopNotifications?'Enabled':'Disabled'}
						</button>
					</div>
					<div class="settings-section"><h4>Change Password</h4>
						<input id="currentPassword" type="password" placeholder="Current Password">
						<input id="newPassword" type="password" placeholder="New Password">
						<input id="confirmPassword" type="password" placeholder="Confirm New Password">
						<div id="settings-passwordRequirements" style="display:flex;flex-direction:column;gap:6px;margin-top:8px;padding:10px;background:var(--input-bg);border-radius:8px;">
							<div id="settings-req-length" class="requirement"><span class="checkbox">✓</span> <span class="text">At least 8 characters</span></div>
							<div id="settings-req-uppercase" class="requirement"><span class="checkbox">✓</span> <span class="text">One uppercase letter</span></div>
							<div id="settings-req-lowercase" class="requirement"><span class="checkbox">✓</span> <span class="text">One lowercase letter</span></div>
							<div id="settings-req-number" class="requirement"><span class="checkbox">✓</span> <span class="text">One number</span></div>
						</div>
						<button onclick="changePassword()">Save Password</button>
					</div>
					<div class="settings-section"><h4>Credits & About</h4>
						<div class="credit-item"><strong>Developed by:</strong> <span>[Your Name/Alias Here]</span></div>
						<div class="credit-item"><strong>Powered by:</strong> <a href="https://firebase.google.com/" target="_blank" rel="noopener noreferrer">Firebase Realtime Database</a></div>
						<div class="credit-item"><strong>UI Inspired by:</strong> <span>Discord</span></div>
						<div class="credit-item" style="margin-top:10px; font-style: italic;"><span>Version: October 2025</span></div>
					</div>
					<div class="settings-section"><h4>Danger Zone</h4>
						<button class="btn-danger" onclick="showDeleteAccountConfirmation()">Delete My Account</button>
					</div>`;
				showModal("User Settings",`Settings for ${username}`,()=>closeModal(),
					{showInput:false,customHTML:(()=>{const d=document.createElement('div');d.innerHTML=settingsHTML;return d;})(),confirmText:"Done"});
				const newPwdInput=document.getElementById("newPassword");
				const reqs={
					length:document.getElementById('settings-req-length'),uppercase:document.getElementById('settings-req-uppercase'),
					lowercase:document.getElementById('settings-req-lowercase'),number:document.getElementById('settings-req-number')
				};
				newPwdInput.addEventListener('input',()=>{
					const v=newPwdInput.value;
					reqs.length.classList.toggle('valid',v.length>=8);reqs.uppercase.classList.toggle('valid',/[A-Z]/.test(v));
					reqs.lowercase.classList.toggle('valid',/[a-z]/.test(v));reqs.number.classList.toggle('valid',/[0-9]/.test(v));
				});
			}
			function setSettingsStatus(message,isError=false){
				const el=document.getElementById('settingsStatus');
				if(el){el.textContent=message;el.className=isError?'settings-status error':'settings-status success';}
			}
			function toggleThemeSetting(){toggleTheme();}
			function toggleViewSetting(){toggleView();}
			async function toggleDesktopNotifications(){
				const newState=!userSettings.desktopNotifications;
				await db.ref(`users/${username}/settings/desktopNotifications`).set(newState);
				const btn=document.getElementById('notifToggleBtn');
				if(btn){btn.textContent=`Desktop Notifications: ${newState?'Enabled':'Disabled'}`;}
				setSettingsStatus(`Desktop notifications ${newState?'enabled':'disabled'}.`,false);
			}
			function changePassword(){
				const current=document.getElementById("currentPassword").value;
				const newP=document.getElementById("newPassword").value;
				const confirmP=document.getElementById("confirmPassword").value;
				if(!current||!newP||!confirmP)return setSettingsStatus("Please fill all password fields.",true);
				if(newP.length<8||!/[A-Z]/.test(newP)||!/[a-z]/.test(newP)||!/[0-9]/.test(newP))return setSettingsStatus("New password does not meet all requirements.",true);
				if(newP!==confirmP)return setSettingsStatus("New passwords do not match.",true);
				db.ref(`users/${username}`).once('value').then(snap=>{
					if(snap.val().password===current){
						db.ref(`users/${username}`).update({password:newP});
						setSettingsStatus("Password updated successfully!",false);
						document.getElementById("currentPassword").value="";document.getElementById("newPassword").value="";document.getElementById("confirmPassword").value="";
					}else{
						setSettingsStatus("Incorrect current password.",true);
					}
				});
			}
			async function showDeleteAccountConfirmation(){
				closeModal();
				showModal("Delete Account",`This is irreversible. To confirm, please enter your current password.`,
					async(password)=>{
						if(!password){
							const mc=document.querySelector('.modalCard');mc.classList.add('shake');
							setTimeout(()=>mc.classList.remove('shake'),820);return;
						}
						try{
							const userSnap=await db.ref(`users/${username}`).once('value');
							const userData=userSnap.val();
							if(userData&&userData.password===password){
								const sub=document.getElementById('modalSubtitle');
								sub.textContent="Processing... Please do not close this window.";sub.style.color='var(--muted)';
								document.getElementById('modalInput').style.display='none';
								document.getElementById('modalConfirmBtn').style.display='none';
								document.getElementById('modalCancelBtn').style.display='none';
								await db.ref(`presence/${username}`).onDisconnect().remove();
								
								const messagePromises=[];
								const messagesSnap=await db.ref('messages').once('value');
								if(messagesSnap.exists()){messagesSnap.forEach(channelSnap=>{channelSnap.forEach(messageSnap=>{if(messageSnap.val().user===username){messagePromises.push(db.ref(`messages/${channelSnap.key}/${messageSnap.key}`).update({user:"[Deleted User]"}));}});});}
								await Promise.all(messagePromises);
								
								const dmPromises=[];
								const channelsSnap=await db.ref('channels').once('value');
								if(channelsSnap.exists()){channelsSnap.forEach(channelSnap=>{const cd=channelSnap.val();if(cd.type==='dm'&&cd.members&&cd.members[username]){dmPromises.push(db.ref(`channels/${channelSnap.key}`).remove());}}); }
								await Promise.all(dmPromises);
								
								const updates={};
								updates[`/users/${username}`]=null;updates[`/presence/${username}`]=null;
								await db.ref().update(updates);
								
								document.getElementById('modalTitle').textContent="Success";
								sub.textContent="Your account has been successfully deleted. Click the button below to log out.";
								const confirmBtn=document.getElementById('modalConfirmBtn');
								confirmBtn.textContent="Logout";confirmBtn.style.display='inline-block';
								modalCallback=()=>{window.location.reload();};
							}else{
								const sub=document.getElementById('modalSubtitle');
								sub.textContent="Incorrect password. Please try again.";sub.style.color='#e74c3c';
								document.getElementById('modalInput').value="";
								const mc=document.querySelector('.modalCard');mc.classList.add('shake');
								setTimeout(()=>mc.classList.remove('shake'),820);
							}
						}catch(error){
							console.error("A critical error occurred during account deletion:",error);
							const sub=document.getElementById('modalSubtitle');
							sub.textContent="A critical error occurred. Please refresh and try again.";sub.style.color='#e74c3c';
						}
					},{confirmText:"Delete Account",danger:true,placeholder:"Enter password to confirm..."}
				);
			}

			/* ============================ Init ============================ */
			document.getElementById("loginTab").addEventListener("click",()=>switchAuth("login"));
			document.getElementById("signupTab").addEventListener("click",()=>switchAuth("signup"));
			const authPwdInput=document.getElementById("authPassword");
			const authReqs={
				length:document.getElementById('req-length'),uppercase:document.getElementById('req-uppercase'),
				lowercase:document.getElementById('req-lowercase'),number:document.getElementById('req-number')
			};
			authPwdInput.addEventListener('input',()=>{
				const v=authPwdInput.value;
				authReqs.length.classList.toggle('valid',v.length>=8);authReqs.uppercase.classList.toggle('valid',/[A-Z]/.test(v));
				authReqs.lowercase.classList.toggle('valid',/[a-z]/.test(v));authReqs.number.classList.toggle('valid',/[0-9]/.test(v));
			});
			updateStatusButton();
		</script>
	</body>
</html>

