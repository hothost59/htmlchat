<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Chat üí¨</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
        :root {
            --bg: #36393f; --panel: #2f3136; --muted: #b9bbbe;
            --accent: #7289da; --card: #4f545c; --card-hover: #5b616b;
            --sidebar-grad: linear-gradient(to bottom, #2f3136, #202225);
            --text: #e6e6e6;
            --input-bg: #202225;
            --auth-grad: linear-gradient(135deg, var(--panel), #202225);
            --channel-bg: #99aab5;
            --channel-text: #000000;
        }

        .light {
            --bg: #f4f6f8; --panel: #ffffff; --muted: #6b7280;
            --accent: #4f46e5; --card: #f3f4f6; --text: #111827;
            --sidebar-grad: linear-gradient(to bottom, #ffffff, #f1f5f9);
            --input-bg: #e5e7eb;
            --auth-grad: linear-gradient(135deg, var(--panel), #f9fafb);
            --channel-bg: #e5e7eb;
            --channel-text: #1f2937;
        }

        html, body {
            height: 100%; width: 100%; margin: 0; padding: 0;
            overflow: hidden;
            font-family: "Segoe UI", Roboto, system-ui, -apple-system, sans-serif;
            color: var(--text);
        }

        body { background: var(--bg); display: flex; flex-direction: column; align-items: stretch; }

        /* --- AUTHENTICATION --- */
        #authDiv { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; z-index: 40; }
        .authCard { width: 360px; background: var(--auth-grad); border-radius: 14px; padding: 22px; box-shadow: 0 14px 40px rgba(0,0,0,0.6); display: flex; flex-direction: column; gap: 12px; }
        .authTabs { display: flex; gap: 8px; }
        .authTabs button { flex: 1; padding: 10px; border-radius: 10px; border: none; cursor: pointer; background: var(--accent); color: white; font-weight: 600; transition: all .18s; }
        .authTabs button.active { opacity: 0.9; }
        .authCard input { width: 100%; padding: 12px; border-radius: 10px; border: none; background: var(--input-bg); color: var(--text); }

        /* --- APP LAYOUT --- */
        #app { flex: 1; min-height: 0; display: flex; gap: 0; align-items: stretch; }
        #sidebar { width: 300px; background: var(--sidebar-grad); padding: 14px; display: flex; flex-direction: column; box-shadow: 2px 0 18px rgba(0,0,0,0.35); gap: 10px; }
        #sidebarHeader { font-weight: 800; font-size: 18px; display: flex; align-items: center; justify-content: space-between; }
        #sidebarHeader .controls { display: flex; gap: 8px; align-items: center; }
        #main { flex: 1; display: flex; flex-direction: column; background: var(--bg); min-width: 0; }
        #chatHeader { padding: 12px 16px; background: var(--panel); border-bottom: 1px solid rgba(255,255,255,0.03); font-weight: 800; display: flex; justify-content: space-between; align-items: center; }
        #chatHeader .meta { display: flex; gap: 10px; align-items: center; color: var(--muted); font-weight: 600; font-size: 13px; }
        #bottomBar { display: flex; gap: 12px; padding: 12px; background: var(--sidebar-grad); align-items: center; }
        #msgInput { flex: 1; padding: 12px 14px; border-radius: 12px; border: none; background: var(--input-bg); color: var(--text); font-size: 15px; }

        /* --- CHANNELS & SIDEBAR --- */
        #channelList { flex: 1; overflow: auto; display: flex; flex-direction: column; gap: 8px; padding-right: 4px; }
        .channelRow { display: flex; align-items: center; justify-content: space-between; gap: 8px; padding: 8px 10px; border-radius: 10px; background: var(--channel-bg); color: var(--channel-text); font-weight: 700; cursor: pointer; transition: all .18s; }
        .channelRow:hover { transform: scale(1.02); background: var(--accent); color: white; }
        .channelRow.active { background: var(--accent); color: white; transform: scale(1.02); }
        
        .close-dm-btn { font-size: 14px; opacity: 0; cursor: pointer; transition: all 0.2s; padding: 2px 4px; border-radius: 50%; }
        .channelRow:hover .close-dm-btn { opacity: 0.7; }
        .close-dm-btn:hover { background: rgba(0,0,0,0.2); opacity: 1; }

        #rightbar { width: 260px; background: var(--panel); padding: 12px 10px; display: flex; flex-direction: column; gap: 10px; box-shadow: -2px 0 18px rgba(0,0,0,0.18); }
        #userList { overflow: auto; display: flex; flex-direction: column; gap: 6px; }
        .userRow { display: flex; gap: 10px; align-items: center; padding: 8px; border-radius: 8px; cursor: pointer; transition: background 0.2s ease; }
        .userRow:hover { background: rgba(255,255,255,0.05); }
        .userRow .userName { font-weight: 700; flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* --- MESSAGES --- */
        #messages { flex: 1; padding: 14px; overflow: auto; display: flex; flex-direction: column; gap: 8px; }
        .message { display: flex; gap: 12px; align-items: flex-start; max-width: 980px; transition: all .28s; opacity: 0; transform: translateY(10px); position: relative; }
        .message.show { opacity: 1; transform: translateY(0); }
        .avatar { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; color: white; background: #6b6f75; flex: 0 0 40px; }
        .msgBody { background: var(--card); padding: 8px 12px; border-radius: 10px; min-width: 0; }
        .msgHeader { font-weight: 700; font-size: 14px; display: flex; gap: 8px; align-items: center; }
        .timestamp { color: var(--muted); font-size: 12px; }

        /* Grouping Logic */
        .grouped .avatar, .grouped .msgHeader .username { visibility: hidden; width: 0; margin-right: 0; height: 0; }
        .grouped { margin-top: -10px; }

        .message-menu { position: absolute; top: -10px; right: 10px; background: var(--panel); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.4); padding: 4px; display: none; cursor: pointer; z-index: 10; gap: 4px; }
        .message:hover .message-menu { display: flex; }
        .menu-item { padding: 6px 8px; border-radius: 4px; font-size: 13px; font-weight: 600; }
        .menu-item:hover { background: var(--accent); color: white; }

        /* --- SETTINGS STYLING --- */
        .settings-section { margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--card); }
        .settings-section:first-child { margin-top: 0; padding-top: 0; border-top: none; }
        .settings-section h4 { margin: 0 0 10px 0; color: var(--muted); text-transform: uppercase; font-size: 11px; letter-spacing: 1px; }
        .settings-section input { width: 95%; padding: 8px; margin-bottom: 8px; border-radius: 5px; border: none; background: var(--input-bg); color: var(--text); }
        .credit-item { font-size: 14px; color: var(--muted); margin-bottom: 8px; }
        .credit-item strong { color: var(--text); }

        /* --- MODALS & UI --- */
        #modalOverlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 50; }
        .modalCard { background: var(--panel); padding: 18px; border-radius: 12px; width: 380px; display: flex; flex-direction: column; gap: 10px; max-height: 90vh; overflow-y: auto; }
        #modalCustomContent .message { background: var(--bg); border-radius: 8px; padding: 10px; opacity: 1; transform: none; pointer-events: none; }
        .modalActions { display: flex; gap: 8px; justify-content: flex-end; }
        
        .statusDot { width: 10px; height: 10px; border-radius: 50%; flex: 0 0 10px; }
        .status-online { background: #2ecc71; }
        .status-away { background: #f1c40f; }
        .status-offline { background: #95a5a6; }

        .badge { background: #ff5b5b; color: white; border-radius: 999px; padding: 2px 8px; font-size: 12px; font-weight: 700; }
        .requirement { display: flex; align-items: center; gap: 8px; color: var(--muted); transition: color 0.3s ease; font-size: 13px; }
        .requirement.valid { color: #2ecc71; }
        
        #scrollBtn { position: fixed; right: 26px; bottom: 96px; padding: 10px 12px; border-radius: 12px; border: none; background: var(--accent); color: white; cursor: pointer; opacity: 0; transition: opacity .25s, transform .18s; }
        #scrollBtn.show { opacity: 1; transform: translateY(0); }
        .tinyBtn { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); padding: 6px 8px; border-radius: 8px; color: var(--muted); cursor: pointer; transition: all 0.2s ease; }
        #submitBtn, .modalActions button { padding: 10px 16px; border-radius: 8px; border: none; background: var(--accent); color: white; font-weight: 700; cursor: pointer; }
        .btn-danger { background-image: linear-gradient(to top, #c0392b 0%, #e74c3c 100%) !important; color: white !important; }

        .browse-channel-list { max-height: 200px; overflow-y: auto; border: 1px solid var(--card); border-radius: 5px; padding: 5px; display: flex; flex-direction: column; gap: 4px; margin-bottom: 10px; }
        .browse-channel-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-radius: 5px; }
        .browse-channel-item button { padding: 6px 10px; font-size: 12px; border: none; border-radius: 6px; color: white; cursor: pointer; background: var(--accent); }
        .browse-channel-item button:disabled { opacity: 0.5; }

        .reply-quote { background: var(--bg); border-left: 3px solid var(--accent); padding: 4px 8px; margin-bottom: 4px; font-size: 13px; border-radius: 4px; color: var(--muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: pointer; }
        .mention-highlight { background-color: hsla(235, 85%, 65%, 0.3); color: #c1cef8; font-weight: 700; padding: 1px 3px; border-radius: 3px; }

        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
        .shake { animation: shake 0.6s cubic-bezier(.36,.07,.19,.97) both; }
        @media (max-width:1000px){ #rightbar{display:none} #sidebar{width:220px} }
    </style>
</head>
<body class="cozy">

    <!-- Auth UI -->
    <div id="authDiv">
        <div class="authCard">
            <div style="display:flex; align-items:center; justify-content:space-between;">
                <div class="authTabs" role="tablist">
                    <button id="loginTab" class="active" onclick="switchAuth('login')">Login</button>
                    <button id="signupTab" onclick="switchAuth('signup')">Sign Up</button>
                </div>
                <div style="display:flex; gap:8px;">
                    <button class="tinyBtn" id="themeBtn" title="Toggle theme" onclick="toggleTheme()">üåô</button>
                    <button class="tinyBtn" id="viewBtn" title="Toggle view" onclick="toggleView()">üõãÔ∏è</button>
                </div>
            </div>
            <input id="authUsername" placeholder="Username" />
            <input id="authPassword" placeholder="Password" type="password" />
            <input id="authConfirm" placeholder="Confirm Password" type="password" style="display:none" />
            <div id="passwordRequirements" style="display: none; flex-direction: column; gap: 6px; margin-top: 8px; padding: 10px; background: var(--input-bg); border-radius: 8px;">
                <div id="req-length" class="requirement">‚úÖ <span>8+ characters</span></div>
                <div id="req-upper" class="requirement">‚úÖ <span>One uppercase</span></div>
                <div id="req-num" class="requirement">‚úÖ <span>One number</span></div>
            </div>
            <button id="submitBtn" onclick="submitAuth()">Login</button>
            <div id="authMessage" style="text-align: center; font-size: 14px; margin-top: 5px; color:#e74c3c;"></div>
        </div>
    </div>

    <!-- App UI -->
    <div id="app" style="display: none;">
        <div id="sidebar">
            <div id="sidebarHeader">
                <div>Channels üó®Ô∏è</div>
                <div class="controls">
                    <button id="notifBtn" class="tinyBtn" onclick="showNotificationsModal()">üîî <div class="badge" id="notifBadge"></div></button>
                    <button id="myStatusBtn" class="tinyBtn" onclick="cycleStatus()">üü¢</button>
                    <button class="tinyBtn" onclick="showSettingsModal()">‚öôÔ∏è</button>
                    <button class="tinyBtn" onclick="logout()">üö™</button>
                </div>
            </div>
            <div id="channelList"></div>
            <button onclick="showBrowseDialog()" style="width:100%; padding:12px; border-radius:8px; border:none; background:var(--accent); color:white; font-weight:700; cursor:pointer; margin-top:10px;">Browse / Create</button>
        </div>

        <div id="main">
            <div id="chatHeader">
                <div id="chatTitle">No channel selected</div>
                <div id="meLabel" style="font-size:12px;color:var(--muted)"></div>
            </div>
            <div style="display:flex; flex:1; min-height:0;">
                <div id="messages"></div>
                <div id="rightbar">
                    <div style="font-weight:800; margin-bottom:10px;">Users üë•</div>
                    <div id="userList"></div>
                </div>
            </div>
            <div id="replyPreview" style="display:none; padding:8px 12px; background:var(--panel); border-top:1px solid var(--card);">
                <span onclick="cancelReply()" style="float:right; cursor:pointer; font-weight:bold;">‚úñÔ∏è</span>
                Replying to <strong id="replyUser"></strong>: <span id="replyText" style="opacity:0.6;"></span>
            </div>
            <div id="bottomBar">
                <input id="msgInput" placeholder="Type a message..." onkeydown="if(event.key==='Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); }" />
                <button id="sendBtn" onclick="sendMessage()" style="padding:10px 20px; background:var(--accent); color:white; border-radius:10px; border:none; cursor:pointer; font-weight:700;">Send</button>
            </div>
        </div>
    </div>

    <button id="scrollBtn">‚¨áÔ∏è</button>

    <!-- Modal Engine -->
    <div id="modalOverlay">
        <div class="modalCard">
            <h3 id="modalTitle"></h3>
            <div id="modalSubtitle" style="font-size:14px; color:var(--muted); margin-bottom:10px;"></div>
            <div id="modalCustomContent"></div>
            <input id="modalInput" autocomplete="off" style="display:none; padding:10px; border-radius:8px; background:var(--input-bg); color:var(--text); border:none;" />
            <div class="modalActions" style="display:flex; gap:8px; justify-content:flex-end; margin-top:10px;">
                <button id="modalConfirmBtn" onclick="submitModal()" style="padding:8px 16px; background:var(--accent); color:white; border-radius:5px; border:none; cursor:pointer;">OK</button>
                <button id="modalCancelBtn" onclick="closeModal()" style="padding:8px 16px; background:var(--card); color:white; border-radius:5px; border:none; cursor:pointer;">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyDbyrqzcZ4Wk57xBNVDzNuRerQaBx2p1L0",
            authDomain: "htmlchat-8b2c5.firebaseapp.com",
            databaseURL: "https://htmlchat-8b2c5-default-rtdb.firebaseio.com",
            projectId: "htmlchat-8b2c5",
            storageBucket: "htmlchat-8b2c5.firebasestorage.app",
            messagingSenderId: "678413131330",
            appId: "1:678413131330:web:7685c9e904b8f4d055d7db"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // --- GLOBALS ---
        let username = "";
        let currentChannel = "";
        let myStatus = "online";
        let lastMsgTime = 0;
        let replyingToId = null;
        let modalCallback = null;
        let lastMessageMeta = { user: null, ts: 0 };
        let autoScroll = true;
        let compactView = false;
        let lightTheme = false;
        let userSettings = { desktopNotifications: true };

        // --- AUTOMOD BLACKLIST ---
        const BLACKLIST = ["nga", "ngas", "fk", "ngga", "assfuck", "cuntfucker", "niggers", "niggerhole", "nigger", "balllicker", "nlgger", "porchmonkey", "Porch-monkey", "cunt", "asswhore", "fuck", "assjockey", "Dothead", "blacks", "cumqueen", "fatfucker", "Jigaboo", "jiggabo", "nlggor", "snownigger", "Spearchucker", "Timber-nigger", "shitnigger", "asslick", "shithead", "asshole", "cuntlicker", "kunt", "spaghettinigger", "Towel-head", "Chernozhopy", "asslicker", "Bluegum", "twat", "ABCD", "bitchslap", "bulldyke", "choad", "cumshot", "fatass", "jigger", "kyke", "cumskin", "asian", "asscowboy", "assmuncher", "banging", "Burrhead", "Camel-Jockey", "coon", "crotchrot", "cumfest", "dicklicker", "fag", "fagot", "felatio", "fatfuck", "goldenshower", "hore", "jackoff", "jigg", "jigga", "jizjuice", "jizm", "jiz", "jigger", "jizzim", "kumming", "kunilingus", "Moolinyan", "motherfucking", "motherfuckings", "phuk", "Sheboon", "shitforbrains", "slanteye", "spick", "fuuck", "antinigger", "aperest", "Americoon", "ABC", "Aunt-Jemima", "queer", "anal", "asspirate", "addict", "bitch", "ass", "Buddhahead", "chode", "phuking", "phukking", "bastard", "bulldike", "dripdick", "assassination", "A-rab", "Buckra", "bootycall", "assholes", "assbagger", "cheesedick", "cooter", "cum", "cumquat", "cunnilingus", "datnigga", "deepthroat", "dick", "dickforbrains", "dickbrain", "dickless", "dike", "diddle", "dixiedyke", "Eskimo", "fannyfucker", "fatso", "fckcum", "Golliwog", "Goyim", "homobangers", "hooters", "Indognesial", "Indonesial", "jew", "jijjiboo", "knockers", "kummer", "mothafucka", "mooncricket", "Moon-Cricket", "Oven-Dodger", "Peckerwood", "phuked", "piccaninny", "picaninny", "phuq", "Polock", "poorwhitetrash", "prick", "pu55y", "Pshek", "slut", "jizzum", "cunteyed", "Spic", "Swamp-Guinea", "stupidfucker", "stupidfuck", "titfuck", "Twinkie", "cock", "Abeed", "analannie", "asshore", "Beaner", "Bootlip", "Burr-head", "buttfucker", "butt-fucker", "Uncle-Tom", "cocksmoker", "Africoon", "AmeriKKKunt", "antifaggot", "assklown", "asspuppies", "blackman", "jism", "blumpkin", "retard", "Gringo", "douchebag", "Piefke", "areola", "backdoorman", "Abbie", "bigbutt", "buttface", "cumbubble", "cumming", "Dego", "dong", "doggystyle", "doggiestyle", "erection", "feces", "goddamned", "gonzagas", "Greaser", "Greaseball", "handjob", "Half-breed", "horney", "jihad", "kumquat", "Lebo", "Moskal", "Mountain-Turk", "nofuckingway", "orgies", "orgy", "pecker", "poontang", "poon", "Polentone", "pu55i", "shitfuck", "shiteater", "shitdick", "sluts", "slutt", "Mangal", "Hymie", "stiffy", "titfucker", "twink", "asspacker", "barelylegal", "beaner", "Bozgor", "bumfuck", "shit for brains", "butchdyke", "butt-fuckers", "buttpirate", "cameljockey", "Carcamano", "Chankoro", "Choc-ice", "Chug", "Ciapaty-or-ciapak", "Cina", "cocksucer", "crackwhore", "Bougnoule", "unfuckable", "Africoon-Americoon", "Africoonia", "Americunt", "apesault", "Assburgers", "fucktardedness", "sheepfucker", "Wuhan-virus", "Wetback", "Aseng", "bumblefuck", "fastfuck", "itch", "nizzle", "Oriental", "cisgender", "ballsack", "penis", "zigabo", "Bule", "breastman", "bountybar", "Bounty-bar", "bondage", "bombing", "bullshit", "asses", "cancer", "cunilingus", "cummer", "dicklick", "ejaculation", "faeces", "fairy", "hoes", "idiot", "Laowai", "Leb", "muff", "muffdive", "Oreo", "orgasm", "orgasim", "osama", "peepshow", "Petrol-sniffer", "perv", "prickhead", "shitfit", "spermbag", "suckmytit", "suckmydick", "suckmyass", "suckme", "suckdick", "Yuon", "motherfucker", "groe", "Ali Baba", "retarded", "assfucker", "assmunch", "assranger", "Ayrab", "assclown", "buttfuck", "butt-fuck", "buttman", "Chink", "cocksucker", "cooly", "Coon-ass", "crotchmonkey", "Bohunk", "cockcowboy", "cocksmith", "catfucker", "fucktardedly", "trans-testicle", "Wigger", "whiskeydick", "aboriginal", "asskisser", "whitelist", "Latinx", "yambag", "boob", "beef curtains", "clunge", "af", "wokeness", "bitchez", "Iceberg Fuckers", "Zhyd", "bellend", "arsehole", "tatas", "assassinate", "boonga", "booby", "bullcrap", "defecate", "Dhoti", "dope", "hobo", "bigass", "hussy", "illegal", "ky", "moneyshot", "molestor", "nooner", "nookie", "nookey", "Paleface", "pansy", "peehole", "phonesex", "period", "pornking", "pornflick", "porn", "pooper", "sexwhore", "shitface", "shit", "slav", "slimeball", "sniggers", "snowback", "snowf", "snow-f", "spermherder", "spankthemonkey", "spitter", "strapon", "Tacohead", "suckoff", "titbitnipply", "Turco-Albanian", "tranny", "trannie", "zhidovka", "zhid", "Bakra", "Afro engineering", "Ah Chah", "alligatorbait", "arabs", "Arabush", "Ashke-Nazi", "assblaster", "assmonkey", "badfuck", "bazongas", "beatoff", "bazooms", "Balija", "bunghole", "butchdike", "buttfuckers", "Boche", "buttbang", "butt-bang", "buttmunch", "Charlie", "chav", "Chinaman", "coloured", "boong", "butchbabes", "clit", "cockknob", "cocksucking", "cocktease", "Cokin", "anchor-baby", "cumsock", "fisting", "fuck-you", "Fritzie", "transgendered", "White-trash", "whitetrash", "whop", "wtf", "Vatnik", "welfare queen", "assman", "black", "Gyopo", "goddam", "minge", "punani", "douche", "doofus", "munter", "moron", "ballgag", "femsplaining", "asslover", "looney", "Boonga", "fat", "homosexual", "turd", "zhydovka", "effing", "minger", "dullard", "buggery", "brea5t", "boong", "addicted", "demon", "devilworshipper", "deth", "destroy", "doo-doo", "doodoo", "escort", "farting", "fairies", "husky", "incest", "Hunky", "jiggy", "laid", "molester", "Mzungu", "nigglings", "niggling", "niggles", "pee-pee", "pi55", "phungky", "porno", "pooping", "prostitute", "pros", "sexslave", "sextogo", "shag", "shithappens", "shithapens", "shitfull", "shitcan", "shinola", "slavedriver", "sleezeball", "spermhearder", "swastika", "shits", "trots", "trisexual", "twobitwhore", "Munt", "gangsta", "Abo", "addicts", "Alligator bait", "analsex", "Redskin", "Gypsy", "Ang mo", "Ape", "arab", "Aravush", "Armo", "arse", "assclown", "asswipe", "Beaney", "beatyourmeat", "bigbastard", "bitches", "Bogtrotter", "bung", "beaver", "bestial", "bogan", "Cabbage-Eater", "carpetmuncher", "carruth", "cocklover", "cockrider", "cornhole", "bollock", "Bog-Irish", "chinamen", "clamdigger", "clamdiver", "dwarf", "cakewalk", "ftw", "fml", "handicapped", "cawk", "carpet-muncher", "fuzzy-headed", "full-blood", "fuckity-bye", "frogess", "Norte", "troid", "willy", "pud", "pubiclice", "whitewashing", "Brit\b"];

        // --- AUTOMOD ENGINE ---
        function autoMod(text) {
            let p = text;
            if (p.length > 500) p = p.substring(0, 500) + "...";
            if (/(.)\1{8,}/.test(p)) return "ü§ê (Flooding blocked)";
            BLACKLIST.forEach(word => {
                const regex = new RegExp(`\\b${word}\\b`, 'gi');
                p = p.replace(regex, "ü§ê");
            });
            const capsCount = (p.match(/[A-Z]/g) || []).length;
            if (capsCount > p.length * 0.7 && p.length > 5) p = p.toLowerCase();
            return p;
        }

        // --- UTILS ---
        function uidColor(name) {
            if (!name) return "#7289da";
            const palette = ["#e67e22","#e74c3c","#9b59b6","#16a085","#f39c12","#3498db","#2ecc71","#d35400","#1abc9c","#8e44ad"];
            let h = 0; for(let i=0; i<name.length; i++) h = (h<<5)-h + name.charCodeAt(i); h = Math.abs(h);
            return palette[h % palette.length];
        }

        function initials(name) { return name ? name.trim().charAt(0).toUpperCase() : "?"; }

        function nowHHMM(ts) {
            const d = ts ? new Date(ts) : new Date();
            return `${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`;
        }

        function generateAvatarUrl(user) {
            const canvas = document.createElement('canvas'); canvas.width = 128; canvas.height = 128;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = uidColor(user); ctx.fillRect(0,0,128,128);
            ctx.fillStyle = '#FFFFFF'; ctx.font = 'bold 72px sans-serif';
            ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            ctx.fillText(initials(user), 64, 64);
            return canvas.toDataURL();
        }

        function toggleTheme() {
            lightTheme = !lightTheme;
            document.documentElement.classList.toggle("light", lightTheme);
            const btn = document.getElementById("themeBtn");
            if (btn) btn.textContent = lightTheme ? "‚òÄÔ∏è" : "üåô";
        }

        function toggleView() {
            compactView = !compactView;
            document.body.classList.toggle("compact", compactView);
            const btn = document.getElementById("viewBtn");
            if (btn) btn.textContent = compactView ? "üìè" : "üõãÔ∏è";
        }

        // --- AUTH ENGINE ---
        function switchAuth(mode) {
            const isS = (mode === 'signup');
            document.getElementById("loginTab").classList.toggle("active", mode === 'login');
            document.getElementById("signupTab").classList.toggle("active", isS);
            document.getElementById("authConfirm").style.display = isS ? "block" : "none";
            document.getElementById("passwordRequirements").style.display = isS ? "flex" : "none";
            document.getElementById("authMessage").textContent = "";
        }

        async function submitAuth() {
            const u = document.getElementById("authUsername").value.trim();
            const p = document.getElementById("authPassword").value;
            const c = document.getElementById("authConfirm").value;
            if (!u || !p) return;
            const isSignup = document.getElementById("signupTab").classList.contains("active");

            if (isSignup) {
                if (u.length < 3) return (document.getElementById("authMessage").textContent = "Username too short");
                if (p.length < 8) return (document.getElementById("authMessage").textContent = "Password too weak");
                if (p !== c) return (document.getElementById("authMessage").textContent = "Passwords don't match");
                const snap = await db.ref("users/" + u).once("value");
                if (snap.exists()) return (document.getElementById("authMessage").textContent = "Username taken");
                await db.ref("users/" + u).set({ password: p, settings: { desktopNotifications: true } });
            } else {
                const snap = await db.ref("users/" + u).once("value");
                if (!snap.exists() || snap.val().password !== p) return (document.getElementById("authMessage").textContent = "Invalid login");
            }
            username = u;
            afterLogin();
        }

        function afterLogin() {
            document.getElementById("authDiv").style.display = "none";
            document.getElementById("app").style.display = "flex";
            document.getElementById("meLabel").textContent = "üë§ " + username;
            loadChannels(); startPresence(); listenToNotifs(); attachScrollHandler(); loadUserList();
        }

        function logout() { location.reload(); }

        // --- MODAL ENGINE ---
        function showModal(title, sub, callback, options = {}) {
            modalCallback = callback;
            document.getElementById("modalTitle").textContent = title;
            document.getElementById("modalSubtitle").textContent = sub;
            document.getElementById("modalOverlay").style.display = "flex";
            const input = document.getElementById("modalInput");
            input.style.display = options.showInput ? "block" : "none";
            input.value = "";
            const content = document.getElementById("modalCustomContent");
            content.innerHTML = "";
            if (options.customHTML) content.appendChild(options.customHTML);
            if (options.showInput) input.focus();
            document.getElementById("modalCancelBtn").style.display = options.hideCancel ? "none" : "block";
        }

        function closeModal() { document.getElementById("modalOverlay").style.display = "none"; }
        
        function submitModal() { 
            const input = document.getElementById("modalInput");
            const value = input.style.display !== 'none' ? input.value.trim() : null;
            if (modalCallback) modalCallback(value !== null ? (value || true) : true); 
            closeModal(); 
        }

        // --- SIDEBAR USER LIST ENGINE ---
        function loadUserList() {
            const list = document.getElementById("userList");
            db.ref("users").on("value", (uSnap) => {
                db.ref("presence").on("value", (pSnap) => {
                    const presence = pSnap.val() || {};
                    const users = uSnap.val() || {};
                    const userArray = Object.keys(users).map(name => ({ name, status: presence[name]?.status || "offline" }));
                    const statusOrder = { online: 0, away: 1, offline: 2 };
                    userArray.sort((a, b) => statusOrder[a.status] - statusOrder[b.status] || a.name.localeCompare(b.name));
                    list.innerHTML = "";
                    userArray.forEach(user => {
                        const row = document.createElement("div");
                        row.className = "userRow";
                        row.innerHTML = `<div class="avatar" style="background:${uidColor(user.name)}; width:34px; height:34px; font-size:14px;">${initials(user.name)}</div>
                                         <div class="userName">${user.name}</div>
                                         <div class="statusDot status-${user.status}"></div>`;
                        row.onclick = () => createDMWith(user.name);
                        list.appendChild(row);
                    });
                });
            });
        }

        // --- CHANNEL ENGINE ---
        async function loadChannels() {
            const uSnap = await db.ref(`users/${username}`).once('value');
            const hidden = uSnap.val()?.hiddenChannels || {};

            db.ref("channels").on("value", snap => {
                const list = document.getElementById("channelList");
                list.innerHTML = "";
                snap.forEach(ch => {
                    const data = ch.val();
                    if (data.type === "dm" && (!data.members || !data.members[username] || data.members[username].active === false)) return;
                    if (data.type !== "dm" && hidden[ch.key]) return;

                    const row = document.createElement("div");
                    row.className = "channelRow" + (ch.key === currentChannel ? " active" : "");
                    row.innerHTML = `<div class="channelLeft"># ${ch.key}</div>`;
                    
                    const btn = document.createElement("span"); btn.innerHTML = "‚úñÔ∏è"; btn.className = "close-dm-btn";
                    btn.onclick = (e) => { 
                        e.stopPropagation(); 
                        data.type === "dm" ? closeDM(ch.key) : hideChannel(ch.key); 
                    };
                    row.appendChild(btn);
                    row.onclick = () => joinChannel(ch.key);
                    list.appendChild(row);
                });
            });
        }

        async function joinChannel(name) {
            if (currentChannel) db.ref("messages/" + currentChannel).off();
            currentChannel = name;
            document.getElementById("chatTitle").textContent = "# " + name;
            document.getElementById("messages").innerHTML = "";
            lastMessageMeta = { user: null, ts: 0 };
            
            const ref = db.ref("messages/" + name);
            ref.on("child_added", snap => appendMessage(snap.val(), snap.key));
            
            ref.on("child_removed", snap => {
                const el = document.querySelector(`.message[data-id="${snap.key}"]`);
                if (el) el.remove();
            });

            ref.on("child_changed", snap => {
                const el = document.querySelector(`.message[data-id="${snap.key}"] .msgText`);
                if (el) el.textContent = snap.val().text;
            });
        }

        async function createDMWith(other) {
            if (other === username) return;
            const id = [username, other].sort().join("__");
            const snap = await db.ref("channels/dm__" + id).once("value");
            if (!snap.exists()) {
                const members = {}; members[username] = { active: true }; members[other] = { active: true };
                await db.ref("channels/dm__" + id).set({ type: "dm", members: members });
            } else {
                db.ref(`channels/dm__${id}/members/${username}`).update({ active: true });
            }
            joinChannel("dm__" + id);
        }

        function closeDM(id) { db.ref(`channels/${id}/members/${username}`).update({ active: false }); if(currentChannel===id) currentChannel=""; loadChannels(); }
        async function hideChannel(id) { await db.ref(`users/${username}/hiddenChannels/${id}`).set(true); if(currentChannel===id) currentChannel=""; loadChannels(); }

        // --- MESSAGE ENGINE ---
        async function appendMessage(m, id) {
            const container = document.getElementById("messages");
            const within = (m.ts - lastMessageMeta.ts) < 300000;
            const isGrouped = lastMessageMeta.user === m.user && within && !m.replyTo;
            const div = document.createElement("div");
            div.className = "message show" + (isGrouped ? " grouped" : "");
            div.dataset.id = id;

            let replyHTML = "";
            if (m.replyTo) {
                const rSnap = await db.ref(`messages/${currentChannel}/${m.replyTo}`).once('value');
                if (rSnap.exists()) replyHTML = `<div class="reply-quote" onclick="jumpTo('${m.replyTo}')">‚Ü©Ô∏è @${rSnap.val().user}: ${rSnap.val().text.substring(0,40)}</div>`;
            }

            div.innerHTML = `<div class="avatar" style="background:${uidColor(m.user)}">${initials(m.user)}</div>
                <div class="msgBody">${replyHTML}
                    <div class="msgHeader"><span class="username" style="color:${uidColor(m.user)}">${m.user}</span><span class="timestamp">${nowHHMM(m.ts)}</span></div>
                    <div class="msgText">${m.text}</div>
                </div>
                <div class="message-menu">
                    <div class="menu-item" onclick="replyToUI('${id}', '${m.user}', '${m.text.replace(/'/g, "\\'")}')">‚Ü©Ô∏è</div>
                    <div class="menu-item" onclick="showForwardUI('${id}')">‚Ü™Ô∏è</div>
                    ${m.user === username ? `<div class="menu-item" onclick="showEditUI('${id}')">‚úèÔ∏è</div><div class="menu-item" onclick="deleteMsgUI('${id}')">üóëÔ∏è</div>` : ""}
                </div>`;
            container.appendChild(div);
            if(autoScroll) container.scrollTop = container.scrollHeight;
            lastMessageMeta = { user: m.user, ts: m.ts };
        }

        async function sendMessage() {
            const input = document.getElementById("msgInput");
            let text = input.value.trim();
            if (!text || !currentChannel) return;
            const now = Date.now();
            if (now - lastMsgTime < 1500) { 
                showModal("‚è≥ Rate Limit", "Please wait 1.5 seconds between messages.", null, { showInput: false, hideCancel: true });
                return; 
            }
            text = autoMod(text);
            const msgRef = db.ref("messages/" + currentChannel).push();
            await msgRef.set({ user: username, text: text, ts: now, replyTo: replyingToId });
            input.value = ""; lastMsgTime = now; cancelReply();
        }

        // --- FULL SETTINGS ENGINE ---
        function showSettingsModal() {
            const d = document.createElement('div');
            d.innerHTML = `
                <div id="settingsStatus" style="font-weight:bold; font-size:12px; margin-bottom:10px;"></div>
                <div class="settings-section">
                    <h4>Appearance</h4>
                    <div style="display:flex; gap:8px;">
                        <button onclick="toggleTheme()">üåì Toggle Theme</button>
                        <button onclick="toggleView()">üìè Toggle View</button>
                    </div>
                </div>
                <div class="settings-section">
                    <h4>Notifications</h4>
                    <button id="notifToggleBtn" onclick="toggleDesktopNotifications()">
                        Desktop Notifications: ${userSettings.desktopNotifications ? 'Enabled ‚úÖ' : 'Disabled ‚úñ'}
                    </button>
                </div>
                <div class="settings-section">
                    <h4>Change Password</h4>
                    <input id="currentPassword" type="password" placeholder="Current Password">
                    <input id="newPassword" type="password" placeholder="New Password">
                    <input id="confirmPassword" type="password" placeholder="Confirm New Password">
                    <div id="settings-passwordRequirements" style="display:flex;flex-direction:column;gap:6px;margin-top:8px;padding:10px;background:var(--input-bg);border-radius:8px;">
                        <div id="settings-req-length" class="requirement">‚úÖ At least 8 characters</div>
                        <div id="settings-req-upper" class="requirement">‚úÖ One uppercase letter</div>
                        <div id="settings-req-num" class="requirement">‚úÖ One number</div>
                    </div>
                    <button onclick="changePassword()" style="margin-top:10px;">Save Password</button>
                </div>
                <div class="settings-section">
                    <h4>Credits & About</h4>
                    <div class="credit-item"><strong>Developed by:</strong> <span>hothost59</span></div>
                    <div class="credit-item" style="margin-top:10px; font-style: italic;"><span>Final Release: February 2026</span></div>
                </div>
                <div class="settings-section">
                    <button class="btn-danger" style="width:100%; padding:12px; border-radius:8px;" onclick="deleteAccountUI()">üíÄ Delete Account</button>
                </div>`;
            showModal("User Settings ‚öôÔ∏è", `Preferences for ${username}`, null, { customHTML: d, showInput: false });
            
            const nP = document.getElementById("newPassword");
            if(nP) nP.oninput = () => {
                const v = nP.value;
                document.getElementById("settings-req-length").classList.toggle("valid", v.length >= 8);
                document.getElementById("settings-req-upper").classList.toggle("valid", /[A-Z]/.test(v));
                document.getElementById("settings-req-num").classList.toggle("valid", /[0-9]/.test(v));
            };
        }

        async function toggleDesktopNotifications() {
            userSettings.desktopNotifications = !userSettings.desktopNotifications;
            await db.ref(`users/${username}/settings/desktopNotifications`).set(userSettings.desktopNotifications);
            const btn = document.getElementById('notifToggleBtn');
            if(btn) btn.textContent = `Desktop Notifications: ${userSettings.desktopNotifications ? 'Enabled ‚úÖ' : 'Disabled ‚úñ'}`;
        }

        function changePassword() {
            const cur = document.getElementById("currentPassword").value, nP = document.getElementById("newPassword").value, cP = document.getElementById("confirmPassword").value, stat = document.getElementById("settingsStatus");
            if (!cur || !nP || !cP) { stat.textContent = "Fill all fields"; stat.style.color = "#e74c3c"; return; }
            if (nP !== cP) { stat.textContent = "Passwords don't match"; stat.style.color = "#e74c3c"; return; }
            db.ref(`users/${username}`).once('value').then(snap => {
                if (snap.val().password === cur) { db.ref(`users/${username}`).update({ password: nP }); stat.textContent = "Success!"; stat.style.color = "#2ecc71"; }
                else { stat.textContent = "Wrong current password"; stat.style.color = "#e74c3c"; }
            });
        }

        // --- FEATURES ---
        async function deleteAccountUI() {
            closeModal();
            showModal("Confirm Password", "Irreversible: Enter password to wipe account history:", async (p) => {
                const s = await db.ref(`users/${username}`).once('value');
                if (s.val().password === p) {
                    const msgSnap = await db.ref('messages').once('value');
                    const promises = [];
                    msgSnap.forEach(ch => ch.forEach(m => {
                        if(m.val().user === username) promises.push(db.ref(`messages/${ch.key}/${m.key}`).update({user: "[Deleted User]"}));
                    }));
                    await Promise.all(promises);
                    await db.ref(`users/${username}`).remove(); await db.ref(`presence/${username}`).remove(); location.reload();
                } else { alert("Incorrect password"); }
            }, { showInput: true });
        }

        function deleteMsgUI(id) {
            const original = document.querySelector(`.message[data-id="${id}"]`);
            if (!original) return;
            const preview = original.cloneNode(true); preview.querySelector('.message-menu')?.remove();
            showModal("Delete Message üóëÔ∏è", "Permanently remove this message?", (conf) => { if (conf) db.ref(`messages/${currentChannel}/${id}`).remove(); }, { customHTML: preview, showInput: false });
        }

        function showEditUI(id) {
            db.ref(`messages/${currentChannel}/${id}`).once('value', snap => {
                showModal("Edit Message ‚úèÔ∏è", "Update content:", (v) => { if (v) db.ref(`messages/${currentChannel}/${id}`).update({ text: autoMod(v), edited: true }); }, { showInput: true, placeholder: snap.val().text });
            });
        }

        function showForwardUI(id) {
            db.ref(`messages/${currentChannel}/${id}`).once('value', snap => {
                const txt = snap.val().text;
                showModal("Forward ‚Ü™Ô∏è", "Target channel name:", (target) => { if (typeof target === 'string' && target.length > 0) db.ref(`messages/${target}`).push({ user: username, text: "[FWD]: " + txt, ts: Date.now() }); }, { showInput: true });
            });
        }

        // --- ORIGINAL BROWSE DIALOG ---
        async function showBrowseDialog() {
            const channelsSnap = await db.ref('channels').once('value');
            const userSnap = await db.ref(`users/${username}`).once('value');
            const hiddenChannels = userSnap.val()?.hiddenChannels || {};
            const publicChannels = [];
            channelsSnap.forEach(snap => { if (snap.val().type !== 'dm') publicChannels.push({ id: snap.key, data: snap.val() }); });
            
            let listContentHTML = publicChannels.length === 0 ? `<div style="text-align: center; padding: 20px; color: var(--muted);">No channels yet. Start one!</div>` : 
                publicChannels.map(channel => {
                    const isHidden = hiddenChannels[channel.id];
                    return `<div class="browse-channel-item"><span># ${channel.id}</span>
                            <button onclick="unhideChannel('${channel.id}', this)" ${!isHidden?'disabled':''}>${isHidden?'Show':'Joined'}</button></div>`;
                }).join('');

            const browserHTML = document.createElement('div');
            browserHTML.innerHTML = `<div class="browse-channel-list">${listContentHTML}</div><hr style="border-color: var(--card); margin: 15px 0;"><p style="font-size: 14px; color: var(--muted);">Or, create a new one:</p>`;
            
            showModal("Browse & Create Channels", "Manage your channels list.", (newChannelName) => {
                if (typeof newChannelName === 'string' && newChannelName.length > 0) {
                    db.ref("channels/" + newChannelName).once("value").then(snap => {
                        if (!snap.exists()) { db.ref("channels/" + newChannelName).set({ createdBy: username, type: "public" }); joinChannel(newChannelName); }
                    });
                }
            }, { customHTML: browserHTML, showInput: true, placeholder: "new-channel-name" });
        }

        async function unhideChannel(id, btn) { await db.ref(`users/${username}/hiddenChannels/${id}`).remove(); btn.textContent = "Joined"; btn.disabled = true; loadChannels(); }

        function replyToUI(id, user, text) { replyingToId = id; document.getElementById("replyUser").textContent = user; document.getElementById("replyText").textContent = text.substring(0, 30) + "..."; document.getElementById("replyPreview").style.display = "block"; document.getElementById("msgInput").focus(); }
        function cancelReply() { replyingToId = null; document.getElementById("replyPreview").style.display = "none"; }
        function jumpTo(id) { const el = document.querySelector(`.message[data-id="${id}"]`); if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' }); }
        function startPresence() { const ref = db.ref("presence/" + username); ref.set({ status: "online", lastSeen: Date.now() }); ref.onDisconnect().remove(); }
        function cycleStatus() { const map = { online: "away", away: "offline", offline: "online" }; myStatus = map[myStatus]; db.ref("presence/" + username).update({ status: myStatus }); document.getElementById("myStatusBtn").textContent = { online: "üü¢", away: "üü°", offline: "‚ö™" }[myStatus]; }
        function listenToNotifs() { db.ref(`users/${username}/notifications`).on('value', snap => { const b = document.getElementById("notifBadge"); b.style.display = snap.exists() ? "inline" : "none"; b.textContent = snap.numChildren(); }); }

        function showNotificationsModal() {
            db.ref(`users/${username}/notifications`).once('value', snap => {
                const d = document.createElement('div');
                snap.forEach(n => { const i = document.createElement('div'); i.style = "padding:8px; border-bottom:1px solid var(--card); cursor:pointer;"; i.textContent = `@${n.val().from} mentioned you in #${n.val().channel}`; i.onclick = () => { joinChannel(n.val().channel); closeModal(); }; d.appendChild(i); });
                showModal("Mentions üîî", "", null, { customHTML: d, showInput: false });
                db.ref(`users/${username}/notifications`).remove();
            });
        }

        function attachScrollHandler() {
            const m = document.getElementById("messages"), s = document.getElementById("scrollBtn");
            m.onscroll = () => { const atBottom = (m.scrollHeight - m.scrollTop < 800); autoScroll = atBottom; s.classList.toggle("show", !atBottom); };
            s.onclick = () => { m.scrollTop = m.scrollHeight; autoScroll = true; };
        }

        document.getElementById("authPassword").oninput = (e) => {
            const v = e.target.value;
            document.getElementById("req-length").classList.toggle("valid", v.length >= 8);
            document.getElementById("req-upper").classList.toggle("valid", /[A-Z]/.test(v));
            document.getElementById("req-num").classList.toggle("valid", /[0-9]/.test(v));
        };
    </script>
</body>
</html>
