<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Chat üí¨</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
        :root {
            --bg: #36393f;
            --panel: #2f3136;
            --muted: #b9bbbe;
            --accent: #7289da;
            --card: #4f545c;
            --card-hover: #5b616b;
            --sidebar-grad: linear-gradient(to bottom, #2f3136, #202225);
            --text: #e6e6e6;
            --input-bg: #202225;
            --auth-grad: linear-gradient(135deg, var(--panel), #202225);
            --channel-bg: #99aab5;
            --channel-text: #000000;
        }

        .light {
            --bg: #f4f6f8;
            --panel: #ffffff;
            --muted: #6b7280;
            --accent: #4f46e5;
            --card: #f3f4f6;
            --text: #111827;
            --sidebar-grad: linear-gradient(to bottom, #ffffff, #f1f5f9);
            --input-bg: #e5e7eb;
            --auth-grad: linear-gradient(135deg, var(--panel), #f9fafb);
            --channel-bg: #e5e7eb;
            --channel-text: #1f2937;
        }

        html, body {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: "Segoe UI", Roboto, system-ui, -apple-system, sans-serif;
            color: var(--text);
        }

        body {
            background: var(--bg);
            display: flex;
            flex-direction: column;
            align-items: stretch;
        }

        #authDiv {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 40;
        }

        .authCard {
            width: 360px;
            background: var(--auth-grad);
            border-radius: 14px;
            padding: 22px;
            box-shadow: 0 14px 40px rgba(0,0,0,0.6);
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .authTabs {
            display: flex;
            gap: 8px;
        }

        .authTabs button {
            flex: 1;
            padding: 10px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            background: var(--accent);
            color: white;
            font-weight: 600;
            transition: all .18s;
        }

        .authTabs button.active { opacity: 0.9; }

        .authCard input {
            width: 100%;
            padding: 12px;
            border-radius: 10px;
            border: none;
            background: var(--input-bg);
            color: var(--text);
        }

        #app {
            flex: 1;
            min-height: 0;
            display: flex;
            gap: 0;
            align-items: stretch;
        }

        #sidebar {
            width: 300px;
            background: var(--sidebar-grad);
            padding: 14px;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 18px rgba(0,0,0,0.35);
            gap: 10px;
        }

        #sidebarHeader {
            font-weight: 800;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        #sidebarHeader .controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        #main {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg);
            min-width: 0;
        }

        #chatHeader {
            padding: 12px 16px;
            background: var(--panel);
            border-bottom: 1px solid rgba(255,255,255,0.03);
            font-weight: 800;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #chatHeader .meta {
            display: flex;
            gap: 10px;
            align-items: center;
            color: var(--muted);
            font-weight: 600;
            font-size: 13px;
        }

        #bottomBar {
            display: flex;
            gap: 12px;
            padding: 12px;
            background: var(--sidebar-grad);
            align-items: center;
        }

        #msgInput {
            flex: 1;
            padding: 12px 14px;
            border-radius: 12px;
            border: none;
            background: var(--input-bg);
            color: var(--text);
            font-size: 15px;
        }

        .sidebarButtons {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
        }

        #channelList {
            flex: 1;
            overflow: auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding-right: 4px;
        }

        .channelRow {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            padding: 8px 10px;
            border-radius: 10px;
            background: var(--channel-bg);
            color: var(--channel-text);
            font-weight: 700;
            cursor: pointer;
            transition: all .18s;
        }

        .channelRow:hover {
            transform: scale(1.02);
            background: var(--accent);
            color: white;
        }

        .channelRow.active {
            background: var(--accent);
            color: white;
            transform: scale(1.02);
        }

        .badge {
            background: #ff5b5b;
            color: white;
            border-radius: 999px;
            padding: 2px 8px;
            font-size: 12px;
            font-weight: 700;
        }

        #rightbar {
            width: 260px;
            background: var(--panel);
            padding: 12px 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            box-shadow: -2px 0 18px rgba(0,0,0,0.18);
        }

        .userRow {
            display: flex;
            gap: 10px;
            align-items: center;
            padding: 6px;
            border-radius: 8px;
            cursor: default;
        }

        .statusDot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .status-online { background: #2ecc71; }
        .status-away { background: #f1c40f; }
        .status-offline { background: #95a5a6; }

        #messages {
            flex: 1;
            padding: 14px;
            overflow: auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .message {
            display: flex;
            gap: 12px;
            align-items: flex-start;
            max-width: 980px;
            transition: all .28s;
            opacity: 0;
            transform: translateY(10px);
            position: relative;
        }

        .message.show {
            opacity: 1;
            transform: translateY(0);
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: white;
            background: #6b6f75;
            flex: 0 0 40px;
        }

        .msgBody {
            background: var(--card);
            padding: 8px 12px;
            border-radius: 10px;
            min-width: 0;
        }

        .msgHeader {
            font-weight: 700;
            font-size: 14px;
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .timestamp {
            color: var(--muted);
            font-size: 12px;
            font-weight: 600;
        }

        .msgText {
            margin-top: 4px;
            color: var(--text);
            white-space: pre-wrap;
            word-break: break-word;
        }

        .message-menu {
            position: absolute;
            top: -10px;
            right: 10px;
            background: var(--panel);
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            padding: 4px;
            display: none;
            cursor: pointer;
            z-index: 10;
            gap: 4px;
        }

        .message:hover .message-menu { display: flex; }

        .menu-item {
            padding: 6px 8px;
            border-radius: 4px;
            font-size: 13px;
        }

        .menu-item:hover {
            background: var(--accent);
            color: white;
        }

        #scrollBtn {
            position: fixed;
            right: 26px;
            bottom: 96px;
            padding: 10px 12px;
            border-radius: 12px;
            border: none;
            background: var(--accent);
            color: white;
            cursor: pointer;
            opacity: 0;
            transition: opacity .25s, transform .18s;
        }

        #scrollBtn.show { opacity: 1; }

        #submitBtn, .sidebarButtons button, #sendBtn, .modalActions button {
            padding: 12px 16px;
            border-radius: 8px;
            border: none;
            background-image: linear-gradient(to top, var(--accent) 0%, #8ea4eb 100%);
            color: white;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: all 0.2s;
        }

        .tinyBtn {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            padding: 6px 8px;
            border-radius: 8px;
            color: var(--muted);
            cursor: pointer;
        }

        #modalOverlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }

        .modalCard {
            background: var(--panel);
            padding: 18px;
            border-radius: 12px;
            width: 380px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .requirement.valid { color: #2ecc71; }
        
        @media (max-width:1000px) {
            #rightbar { display: none; }
            #sidebar { width: 220px; }
        }
    </style>
</head>
<body>

    <!-- Auth UI -->
    <div id="authDiv">
        <div class="authCard">
            <div style="display:flex; align-items:center; justify-content:space-between;">
                <div class="authTabs">
                    <button id="loginTab" class="active">Login</button>
                    <button id="signupTab">Sign Up</button>
                </div>
                <div style="display:flex; gap:8px;">
                    <button class="tinyBtn" id="themeBtn" onclick="toggleTheme()">üåô</button>
                    <button class="tinyBtn" id="viewBtn" onclick="toggleView()">üõãÔ∏è</button>
                </div>
            </div>
            <input id="authUsername" placeholder="Username" />
            <input id="authPassword" placeholder="Password" type="password" />
            <input id="authConfirm" placeholder="Confirm Password" type="password" style="display:none" />
            <div id="passwordRequirements" style="display: none; font-size: 12px;">
                <div id="req-length" class="requirement">‚úñ At least 8 characters</div>
                <div id="req-uppercase" class="requirement">‚úñ One uppercase letter</div>
                <div id="req-number" class="requirement">‚úñ One number</div>
            </div>
            <button id="submitBtn" onclick="submitAuth()">Login</button>
            <div id="authMessage"></div>
        </div>
    </div>

    <!-- Main App -->
    <div id="app" style="display: none;">
        <div id="sidebar">
            <div id="sidebarHeader">
                <div>Channels üó®Ô∏è</div>
                <div class="controls">
                    <button id="notifBtn" class="tinyBtn" onclick="showNotificationsModal()">üîî <div class="badge" id="notifBadge"></div></button>
                    <button id="myStatusBtn" class="tinyBtn" onclick="cycleStatus()">üü¢</button>
                    <button id="settingsBtn" class="tinyBtn" onclick="showSettingsModal()">‚öôÔ∏è</button>
                    <button id="logoutBtn" class="tinyBtn" onclick="logout()">üö™</button>
                    <div id="meLabel" style="font-size:12px;color:var(--muted)"></div>
                </div>
            </div>
            <div id="channelList"></div>
            <div class="sidebarButtons">
                <button onclick="showBrowseDialog()">Browse / Create</button>
            </div>
        </div>

        <div id="main">
            <div id="chatHeader">
                <div id="chatTitle">No channel selected</div>
            </div>
            <div style="display:flex; flex:1; min-height:0;">
                <div id="messages"></div>
                <div id="rightbar">
                    <div style="font-weight:800;">Users üë•</div>
                    <div id="userList" style="overflow:auto; display:flex; flex-direction:column; gap:6px;"></div>
                </div>
            </div>
            <div id="replyPreview" style="display:none; padding:8px; background:var(--panel);">
                <span id="cancelReplyBtn" onclick="cancelReply()">‚úñÔ∏è</span>
                Replying to <strong id="replyUser"></strong>
            </div>
            <div id="bottomBar">
                <input id="msgInput" placeholder="Type a message..." />
                <button id="sendBtn" onclick="sendMessage()">Send</button>
            </div>
        </div>
    </div>

    <button id="scrollBtn">‚¨áÔ∏è</button>

    <!-- Modal System -->
    <div id="modalOverlay">
        <div class="modalCard">
            <h3 id="modalTitle">Modal</h3>
            <div id="modalSubtitle"></div>
            <div id="modalCustomContent"></div>
            <input id="modalInput" autocomplete="off" />
            <div class="modalActions">
                <button id="modalConfirmBtn" onclick="submitModal()">OK</button>
                <button id="modalCancelBtn" onclick="closeModal()">Cancel</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        // --- CONFIG & GLOBALS ---
        const firebaseConfig = {
            apiKey: "AIzaSyDbyrqzcZ4Wk57xBNVDzNuRerQaBx2p1L0",
            authDomain: "htmlchat-8b2c5.firebaseapp.com",
            databaseURL: "https://htmlchat-8b2c5-default-rtdb.firebaseio.com",
            projectId: "htmlchat-8b2c5",
            storageBucket: "htmlchat-8b2c5.firebasestorage.app",
            messagingSenderId: "678413131330",
            appId: "1:678413131330:web:7685c9e904b8f4d055d7db"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let username = "";
        let currentChannel = "";
        let myStatus = "online";
        let replyingToId = null;
        let lastMessageTime = 0; // For AutoMod Rate Limiting

        // --- AUTOMOD LOGIC ---
        const autoMod = (text) => {
            let processed = text;

            // 1. Filter Bad Words
            const banned = ["spam", "scam", "hate", "badword1"]; // Add your list here
            banned.forEach(word => {
                const regex = new RegExp(word, "gi");
                processed = processed.replace(regex, "ü§ê");
            });

            // 2. Prevent excessive caps
            const capsCount = (processed.match(/[A-Z]/g) || []).length;
            if (capsCount > processed.length * 0.7 && processed.length > 5) {
                processed = processed.toLowerCase() + " (AutoMod: Please don't yell)";
            }

            // 3. Repetitive character check (Flood protection)
            if (/(.)\1{9,}/.test(processed)) {
                processed = "ü§ê (AutoMod: Message blocked for flooding)";
            }

            return processed;
        };

        // --- AUTH LOGIC ---
        const switchAuth = (mode) => {
            const isSignup = mode === 'signup';
            document.getElementById("authConfirm").style.display = isSignup ? "block" : "none";
            document.getElementById("passwordRequirements").style.display = isSignup ? "block" : "none";
            document.getElementById("loginTab").classList.toggle("active", !isSignup);
            document.getElementById("signupTab").classList.toggle("active", isSignup);
            document.getElementById("submitBtn").textContent = isSignup ? "Sign Up" : "Login";
        };

        document.getElementById("loginTab").onclick = () => switchAuth('login');
        document.getElementById("signupTab").onclick = () => switchAuth('signup');

        async function submitAuth() {
            const u = document.getElementById("authUsername").value.trim();
            const p = document.getElementById("authPassword").value;
            if (!u || !p) return;

            const snap = await db.ref("users/" + u).once("value");
            if (snap.exists()) {
                if (snap.val().password === p) {
                    username = u;
                    afterLogin();
                } else {
                    alert("Wrong password!");
                }
            } else {
                await db.ref("users/" + u).set({ password: p });
                username = u;
                afterLogin();
            }
        }

        // --- CORE APP LOGIC ---
        function afterLogin() {
            document.getElementById("authDiv").style.display = "none";
            document.getElementById("app").style.display = "flex";
            document.getElementById("meLabel").textContent = "üë§ " + username;
            loadChannels();
            loadUserList();
            startPresence();
        }

        function loadChannels() {
            db.ref("channels").on("value", snap => {
                const list = document.getElementById("channelList");
                list.innerHTML = "";
                snap.forEach(ch => {
                    const div = document.createElement("div");
                    div.className = "channelRow" + (ch.key === currentChannel ? " active" : "");
                    div.textContent = "# " + ch.key;
                    div.onclick = () => joinChannel(ch.key);
                    list.appendChild(div);
                });
            });
        }

        async function joinChannel(name) {
            currentChannel = name;
            document.getElementById("chatTitle").textContent = "# " + name;
            const messagesDiv = document.getElementById("messages");
            messagesDiv.innerHTML = "";
            
            db.ref("messages/" + name).on("child_added", snap => {
                appendMessage(snap.val(), snap.key);
            });
        }

        function appendMessage(m, id) {
            const container = document.getElementById("messages");
            const msg = document.createElement("div");
            msg.className = "message show";
            msg.innerHTML = `
                <div class="avatar" style="background:${uidColor(m.user)}">${m.user[0].toUpperCase()}</div>
                <div class="msgBody">
                    <div class="msgHeader">
                        <span style="color:${uidColor(m.user)}">${m.user}</span>
                        <span class="timestamp">${new Date(m.ts).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                    </div>
                    <div class="msgText">${m.text}</div>
                </div>
            `;
            container.appendChild(msg);
            container.scrollTop = container.scrollHeight;
        }

        async function sendMessage() {
            const input = document.getElementById("msgInput");
            let text = input.value.trim();
            if (!text || !currentChannel) return;

            // --- AUTOMOD TRIGGER ---
            const now = Date.now();
            if (now - lastMessageTime < 1500) {
                alert("‚è≥ Slow down! Don't spam.");
                return;
            }

            text = autoMod(text); // Process through filters

            await db.ref("messages/" + currentChannel).push({
                user: username,
                text: text,
                ts: now
            });

            lastMessageTime = now;
            input.value = "";
        }

        // --- UTILS ---
        function uidColor(name) {
            const colors = ["#e67e22","#e74c3c","#9b59b6","#3498db","#2ecc71"];
            let hash = 0;
            for (let i = 0; i < name.length; i++) hash = name.charCodeAt(i) + ((hash << 5) - hash);
            return colors[Math.abs(hash) % colors.length];
        }

        function toggleTheme() {
            document.documentElement.classList.toggle("light");
        }

        function cycleStatus() {
            const btn = document.getElementById("myStatusBtn");
            const statuses = { "online": ["üü¢", "away"], "away": ["üü°", "offline"], "offline": ["‚ö™", "online"] };
            const [icon, next] = statuses[myStatus];
            myStatus = next;
            btn.textContent = icon;
            db.ref("presence/" + username).update({ status: myStatus });
        }

        function startPresence() {
            const ref = db.ref("presence/" + username);
            ref.set({ status: "online", lastSeen: Date.now() });
            ref.onDisconnect().remove();
        }

        function loadUserList() {
            db.ref("presence").on("value", snap => {
                const list = document.getElementById("userList");
                list.innerHTML = "";
                snap.forEach(u => {
                    const row = document.createElement("div");
                    row.className = "userRow";
                    row.innerHTML = `<span class="statusDot status-${u.val().status}"></span> ${u.key}`;
                    list.appendChild(row);
                });
            });
        }

        // Enter key listener
        document.getElementById("msgInput").onkeydown = (e) => {
            if (e.key === "Enter") sendMessage();
        };

    </script>
</body>
</html>
