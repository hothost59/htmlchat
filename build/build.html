<!-- UGS FILE -->
<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<title>Chat üí¨</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<script>
(function (w, d, s, l, i) {
w[l] = w[l] || [];
w[l].push({ "gtm.start": new Date().getTime(), event: "gtm.js" });
var f = d.getElementsByTagName(s)[0],
j = d.createElement(s),
dl = l != "dataLayer" ? "&l=" + l : "";
j.async = true;
j.src = "https://www.googletagmanager.com/gtm.js?id=" + i + dl;
f.parentNode.insertBefore(j, f);
})(window, document, "script", "dataLayer", "GTM-5XKHS5WN");
</script>
<style>
:root {
--bg: #36393f;
--panel: #2f3136;
--muted: #b9bbbe;
--accent: #7289da;
--card: #4f545c;
--card-hover: #5b616b;
--sidebar-grad: linear-gradient(to bottom, #2f3136, #202225);
--text: #e6e6e6;
--input-bg: #202225;
--auth-grad: linear-gradient(135deg, var(--panel), #202225);
--channel-bg: #99aab5;
--channel-text: #000000;
--bg-secondary: #2b2d31;
--bg-tertiary: #1e1f22;
--text-muted: #b5bac1;
}

.light {
    --bg: #f4f6f8;
    --panel: #ffffff;
    --muted: #6b7280;
    --accent: #4f46e5;
    --card: #f3f4f6;
    --text: #111827;
    --sidebar-grad: linear-gradient(to bottom, #ffffff, #f1f5f9);
    --input-bg: #e5e7eb;
    --auth-grad: linear-gradient(135deg, var(--panel), #f9fafb);
    --channel-bg: #e5e7eb;
    --channel-text: #1f2937;
    --bg-secondary: #f2f3f5;
    --bg-tertiary: #ebedef;
    --text-muted: #5c6370;
  }

  html,
  body {
    height: 100%;
    width: 100%;
    margin: 0;
    padding: 0;
    overflow: hidden;
    font-family:
      "Segoe UI",
      Roboto,
      system-ui,
      -apple-system,
      sans-serif;
    color: var(--text);
  }

  body {
    background: var(--bg);
    display: flex;
    flex-direction: column;
    align-items: stretch;
  }

  #authDiv {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 40;
    background: linear-gradient(-45deg, #2f3136, #202225, #7289da, #2f3136);
    background-size: 400% 400%;
    animation: gradientBG 15s ease infinite;
  }

  .authCard {
    width: 412px;
    background: var(--panel);
    border-radius: 14px;
    padding: 32px;
    box-shadow: 0 14px 40px rgba(0, 0, 0, 0.6);
    display: flex;
    flex-direction: column;
    gap: 12px;
    animation: scaleIn 0.6s cubic-bezier(0.16, 1, 0.3, 1);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
  }

  .auth-label {
    color: var(--muted);
    font-size: 12px;
    font-weight: 700;
    text-transform: uppercase;
    margin-bottom: 8px;
    display: block;
  }

  .authTabs {
    display: flex;
    gap: 8px;
  }

  .authTabs button {
    flex: 1;
    padding: 10px;
    border-radius: 10px;
    border: none;
    cursor: pointer;
    background: var(--accent);
    color: white;
    font-weight: 600;
    transition: all 0.18s;
  }

  .authTabs button.active {
    opacity: 0.9;
  }

  .authCard input {
    width: 100%;
    padding: 12px;
    border-radius: 10px;
    border: none;
    background: var(--input-bg);
    color: var(--text);
  }

  #app {
    flex: 1;
    min-height: 0;
    display: flex;
    gap: 0;
    align-items: stretch;
  }

  #serverList {
    width: 72px;
    background: #202225;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 12px 0;
    gap: 8px;
    overflow-y: auto;
    flex-shrink: 0;
  }

  .serverIcon {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: var(--panel);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 20px;
    position: relative;
    flex-shrink: 0;
  }

  .serverIcon:hover {
    border-radius: 35%;
    background: var(--accent);
  }

  .serverIcon.active {
    border-radius: 35%;
    background: var(--accent);
  }

  .serverIcon img {
    width: 100%;
    height: 100%;
    border-radius: inherit;
    object-fit: cover;
  }

  #sidebar {
    width: 300px;
    background: var(--sidebar-grad);
    padding: 14px;
    display: flex;
    flex-direction: column;
    box-shadow: 2px 0 18px rgba(0, 0, 0, 0.35);
    gap: 10px;
    flex-shrink: 0;
  }

  #sidebarHeader {
    font-weight: 800;
    font-size: 18px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  #sidebarHeader .controls {
    display: flex;
    gap: 8px;
    align-items: center;
  }

  #main {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: var(--bg);
    min-width: 0;
  }

  #chatHeader {
    padding: 12px 16px;
    background: var(--panel);
    border-bottom: 1px solid rgba(255, 255, 255, 0.03);
    font-weight: 800;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  #chatHeader .meta {
    display: flex;
    gap: 10px;
    align-items: center;
    color: var(--muted);
    font-weight: 600;
    font-size: 13px;
  }

  #bottomBar {
    display: flex;
    gap: 12px;
    padding: 12px;
    background: var(--sidebar-grad);
    align-items: center;
  }

  #msgInput {
    flex: 1;
    padding: 12px 14px;
    border-radius: 12px;
    border: none;
    background: var(--input-bg);
    color: var(--text);
    font-size: 15px;
    font-family: inherit;
    resize: none;
    max-height: 200px;
    min-height: 44px;
    overflow-y: hidden;
    line-height: 1.4;
    box-sizing: border-box;
  }

  #channelList {
    flex: 1;
    overflow: auto;
    display: flex;
    flex-direction: column;
    gap: 8px;
    padding-right: 4px;
  }

  .channelRow {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
    padding: 8px 10px;
    border-radius: 10px;
    background: var(--channel-bg);
    color: var(--channel-text);
    font-weight: 700;
    cursor: pointer;
    transition: all 0.25s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  }

  .channelRow:hover {
    transform: scale(1.03) translateY(-2px);
    background: var(--accent);
    color: white;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
  }

  .channelRow.active {
    background: var(--accent);
    color: white;
    transform: scale(1.03);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
  }

  .close-dm-btn {
    font-size: 14px;
    opacity: 0;
    cursor: pointer;
    transition: all 0.2s;
    padding: 2px 4px;
    border-radius: 50%;
  }

  .channelRow:hover .close-dm-btn {
    opacity: 0.7;
  }

  .close-dm-btn:hover {
    background: rgba(0, 0, 0, 0.2);
    opacity: 1;
  }

  #rightbar {
    width: 260px;
    background: var(--panel);
    padding: 12px 10px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    box-shadow: -2px 0 18px rgba(0, 0, 0, 0.18);
    flex-shrink: 0;
  }

  #userList {
    overflow: auto;
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .userRow {
    display: flex;
    gap: 10px;
    align-items: center;
    padding: 8px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .userRow:hover {
    background: rgba(255, 255, 255, 0.05);
    transform: translateX(4px);
  }

  .userRow .userName {
    font-weight: 700;
    flex: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  #messages {
    flex: 1;
    padding: 14px;
    overflow-y: auto;
    overflow-x: hidden;
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .message {
    display: flex;
    gap: 12px;
    align-items: flex-start;
    max-width: 980px;
    transition: all 0.28s;
    opacity: 0;
    transform: translateY(10px);
    position: relative;
  }

  .message.show {
    opacity: 1;
    transform: translateY(0);
    animation: slideInUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
  }

  .avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    color: white;
    background: #6b6f75;
    flex: 0 0 40px;
    overflow: hidden;
  }

  .avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .msgBody {
    background: var(--card);
    padding: 8px 12px;
    border-radius: 10px;
    min-width: 200px;
    max-width: 100%;
    flex: 1;
  }

  .msgHeader {
    font-weight: 700;
    font-size: 14px;
    display: flex;
    gap: 8px;
    align-items: center;
  }

  .timestamp {
    color: var(--muted);
    font-size: 12px;
  }

  .grouped .avatar {
    visibility: hidden;
  }

  .grouped .msgHeader {
    display: none;
  }

  .grouped {
    margin-top: -4px;
  }

  .message-menu {
    position: absolute;
    top: -10px;
    right: 10px;
    background: var(--panel);
    border-radius: 6px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
    padding: 4px;
    display: none;
    cursor: pointer;
    z-index: 10;
    gap: 4px;
  }

  .message:hover .message-menu {
    display: flex;
  }

  .msgText {
    white-space: pre-wrap;
    word-break: break-word;
    line-height: 1.4;
  }

  .menu-item {
    padding: 6px 8px;
    border-radius: 4px;
    font-size: 13px;
    font-weight: 600;
  }

  .menu-item:hover {
    background: var(--accent);
    color: white;
  }

  .settings-section {
    border-top: 1px solid rgba(255, 255, 255, 0.05);
    padding: 20px 0;
    margin: 0;
  }
  .settings-section:first-child {
    border-top: none;
    padding-top: 10px;
  }

  .settings-label {
    color: var(--text-muted);
    text-transform: uppercase;
    font-size: 12px;
    font-weight: 700;
    margin-bottom: 8px;
    display: block;
  }

  .settings-input-group {
    margin-bottom: 20px;
  }

  .settings-input-group input {
    width: 100%;
    box-sizing: border-box;
    padding: 10px;
    background-color: var(--bg-tertiary);
    border: none;
    border-radius: 4px;
    color: var(--text);
    font-size: 14px;
  }

  .discord-btn {
    background-color: var(--accent);
    color: white;
    padding: 10px 20px;
    border-radius: 3px;
    border: none;
    font-weight: 500;
    font-size: 14px;
    cursor: pointer;
    transition: background 0.2s;
  }
  .discord-btn:hover {
    filter: brightness(1.1);
  }

  .danger-zone {
    margin-top: 10px;
    padding: 15px;
    border: 1px solid #ed4245;
    border-radius: 8px;
  }

  .settings-req-box {
    background: var(--bg-secondary);
    padding: 10px;
    border-radius: 4px;
    margin: 10px 0;
    font-size: 13px;
  }

  .settings-section h4 {
    margin: 0 0 10px 0;
    color: var(--muted);
    text-transform: uppercase;
    font-size: 11px;
    letter-spacing: 1px;
  }

  .settings-section input {
    width: 95%;
    padding: 8px;
    margin-bottom: 8px;
    border-radius: 5px;
    border: none;
    background: var(--input-bg);
    color: var(--text);
  }

  .settings-section button {
    background: var(--card);
    color: var(--text);
    border: none;
    padding: 10px 15px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: background 0.2s;
    width: 100%;
    margin-bottom: 5px;
  }

  .settings-section button:hover {
    background: var(--card-hover);
  }

  .settings-section .btn-save {
    background: var(--accent) !important;
    color: white !important;
    margin-top: 10px;
  }

  .credit-item {
    font-size: 14px;
    color: var(--muted);
    margin-bottom: 8px;
  }

  .credit-item strong {
    color: var(--text);
  }

  #modalOverlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.6);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 50;
  }

  .modalCard {
    background: var(--panel);
    padding: 18px;
    border-radius: 12px;
    width: 380px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    max-height: 90vh;
    overflow-y: auto;
    animation: springIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
  }

  #modalCustomContent .message {
    background: var(--bg);
    border-radius: 8px;
    padding: 10px;
    opacity: 1;
    transform: none;
    pointer-events: none;
  }

  .modalActions {
    display: flex;
    gap: 8px;
    justify-content: flex-end;
  }

  .statusDot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    flex: 0 0 10px;
  }

  .status-online {
    background: #2ecc71;
    animation: pulse 2s infinite;
  }

  .status-away {
    background: #f1c40f;
  }

  .status-offline {
    background: #95a5a6;
  }

  .badge {
    background: #ff5b5b;
    color: white;
    border-radius: 999px;
    padding: 2px 8px;
    font-size: 12px;
    font-weight: 700;
  }

  .requirement {
    display: flex;
    align-items: center;
    gap: 8px;
    color: var(--muted);
    transition: color 0.3s ease;
    font-size: 13px;
  }

  .requirement.valid {
    color: #2ecc71;
  }

  #scrollBtn {
    position: fixed;
    right: 26px;
    bottom: 96px;
    padding: 10px 12px;
    border-radius: 12px;
    border: none;
    background: var(--accent);
    color: white;
    cursor: pointer;
    opacity: 0;
    transition:
      opacity 0.25s,
      transform 0.18s;
  }

  #scrollBtn.show {
    opacity: 1;
    transform: translateY(0);
  }

  .tinyBtn {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    padding: 6px 8px;
    border-radius: 8px;
    color: var(--muted);
    cursor: pointer;
    transition: all 0.2s ease;
  }

  #submitBtn,
  #sendBtn,
  .modalActions button {
    padding: 10px 16px;
    border-radius: 8px;
    border: none;
    background: var(--accent);
    color: white;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  #submitBtn:hover,
  #sendBtn:hover,
  .modalActions button:hover {
    transform: translateY(-2px);
    filter: brightness(1.1);
    box-shadow: 0 4px 12px rgba(114, 137, 218, 0.4);
  }

  #submitBtn:active,
  #sendBtn:active,
  .modalActions button:active {
    transform: translateY(0);
  }

  .btn-danger {
    background-image: linear-gradient(
      to top,
      #c0392b 0%,
      #e74c3c 100%
    ) !important;
    color: white !important;
  }

  .browse-channel-list {
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid var(--card);
    border-radius: 5px;
    padding: 5px;
    display: flex;
    flex-direction: column;
    gap: 4px;
    margin-bottom: 10px;
  }

  .browse-channel-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px;
    border-radius: 5px;
  }

  .browse-channel-item button {
    padding: 6px 10px;
    font-size: 12px;
    border: none;
    border-radius: 6px;
    color: white;
    cursor: pointer;
    background: var(--accent);
  }

  .browse-channel-item button:disabled {
    opacity: 0.5;
  }

  .reply-quote {
    background: var(--bg);
    border-left: 3px solid var(--accent);
    padding: 4px 8px;
    margin-bottom: 4px;
    font-size: 13px;
    border-radius: 4px;
    color: var(--muted);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    cursor: pointer;
  }

  .mention-highlight {
    background-color: hsla(235, 85%, 65%, 0.3);
    color: #c1cef8;
    font-weight: 700;
    padding: 1px 3px;
    border-radius: 3px;
  }

  .role-badge {
    display: inline-block;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 11px;
    font-weight: 700;
    margin-left: 4px;
  }

  .profile-pic-option {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    cursor: pointer;
    border: 3px solid transparent;
    transition: all 0.2s;
    object-fit: cover;
  }

  .profile-pic-option:hover {
    border-color: var(--accent);
    transform: scale(1.1);
  }

  .profile-pic-option.selected {
    border-color: var(--accent);
    box-shadow: 0 0 10px var(--accent);
  }

  @keyframes shake {
    10%,
    90% {
      transform: translate3d(-1px, 0, 0);
    }

    20%,
    80% {
      transform: translate3d(2px, 0, 0);
    }

    30%,
    50%,
    70% {
      transform: translate3d(-4px, 0, 0);
    }

    40%,
    60% {
      transform: translate3d(4px, 0, 0);
    }
  }

  .shake {
    animation: shake 0.6s cubic-bezier(0.36, 0.07, 0.19, 0.97) both;
  }

  @keyframes scaleIn {
    from {
      opacity: 0;
      transform: scale(0.9) translateY(10px);
    }

    to {
      opacity: 1;
      transform: scale(1) translateY(0);
    }
  }

  @keyframes slideInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }

    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes pulse {
    0% {
      transform: scale(1);
      box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.4);
    }

    70% {
      transform: scale(1.1);
      box-shadow: 0 0 0 10px rgba(46, 204, 113, 0);
    }

    100% {
      transform: scale(1);
      box-shadow: 0 0 0 0 rgba(46, 204, 113, 0);
    }
  }

  @keyframes gradientBG {
    0% {
      background-position: 0% 50%;
    }

    50% {
      background-position: 100% 50%;
    }

    100% {
      background-position: 0% 50%;
    }
  }

  @keyframes springIn {
    0% {
      transform: scale(0.3);
      opacity: 0;
    }

    50% {
      transform: scale(1.05);
      opacity: 1;
    }

    70% {
      transform: scale(0.9);
    }

    100% {
      transform: scale(1);
    }
  }

  @media (max-width: 1000px) {
    #rightbar {
      display: none;
    }

    #sidebar {
      width: 220px;
    }
  }
</style>
</head>
<body class="cozy">
<noscript
><iframe
src="https://www.googletagmanager.com/ns.html?id=GTM-5XKHS5WN"
height="0"
width="0"
style="display: none; visibility: hidden"
></iframe
></noscript>
<div id="authDiv">
<div class="authCard">
<div
style="
display: flex;
align-items: center;
justify-content: space-between;
position: absolute;
top: 20px;
right: 20px;
"
>
<button
class="tinyBtn"
id="themeBtn"
title="Toggle theme"
onclick="toggleTheme()"
>
üåô
</button>
</div>

<h3
      id="authTitle"
      style="text-align: center; margin-top: 0; font-size: 24px"
    >
      Welcome back!
    </h3>
    <div
      id="authSubtext"
      style="text-align: center; color: var(--muted); margin-bottom: 20px"
    >
      We're so excited to see you again!
    </div>

    <div style="display: none" id="authTabs">
      <button id="loginTab" class="active"></button>
      <button id="signupTab"></button>
    </div>

    <div>
      <label class="auth-label">Username</label>
      <input id="authUsername" placeholder="" />
    </div>

    <div>
      <label class="auth-label">Password</label>
      <input id="authPassword" placeholder="" type="password" />
    </div>

    <div id="authConfirmContainer" style="display: none">
      <label class="auth-label">Confirm Password</label>
      <input id="authConfirm" placeholder="" type="password" />
    </div>
    <div
      id="passwordRequirements"
      style="
        display: none;
        flex-direction: column;
        gap: 6px;
        margin-top: 8px;
        padding: 10px;
        background: var(--input-bg);
        border-radius: 8px;
      "
    >
      <div id="req-length" class="requirement">
        ‚úÖ <span>8+ characters</span>
      </div>
      <div id="req-upper" class="requirement">
        ‚úÖ <span>One uppercase</span>
      </div>
      <div id="req-num" class="requirement">‚úÖ <span>One number</span></div>
    </div>
    <button id="submitBtn" style="width: 100%" onclick="submitAuth()">
      Login
    </button>
    <div
      id="authFooter"
      style="margin-top: 10px; font-size: 14px; color: var(--muted)"
    >
      Need an account?
      <a
        href="#"
        onclick="
          switchAuth('signup');
          return false;
        "
        style="color: var(--accent); text-decoration: none"
        >Register</a
      >
    </div>
    <div
      id="authMessage"
      style="
        text-align: center;
        font-size: 14px;
        margin-top: 5px;
        color: #e74c3c;
      "
    ></div>
  </div>
</div>

<div id="app" style="display: none">
  <div id="serverList"></div>
  
  <div id="sidebar">
    <div id="sidebarHeader">
      <div id="serverName">General</div>
      <div class="controls">
        <button
          id="notifBtn"
          class="tinyBtn"
          onclick="showNotificationsModal()"
        >
          üîî
          <div class="badge" id="notifBadge"></div>
        </button>
        <button id="myStatusBtn" class="tinyBtn" onclick="cycleStatus()">
          üü¢
        </button>
        <button class="tinyBtn" onclick="showSettingsModal()">‚öôÔ∏è</button>
        <button class="tinyBtn" onclick="showServerSettingsModal()">üîß</button>
        <button class="tinyBtn" onclick="logout()">üö™</button>
      </div>
    </div>
    <div id="channelList"></div>
    <button
      id="createChannelBtn"
      onclick="showBrowseDialog()"
      style="
        width: 100%;
        padding: 12px;
        border-radius: 8px;
        border: none;
        background: var(--accent);
        color: white;
        font-weight: 700;
        cursor: pointer;
        margin-top: 10px;
      "
    >
      Create Channel
    </button>
  </div>

  <div id="main">
    <div id="chatHeader">
      <div id="chatTitle">No channel selected</div>
      <div id="meLabel" style="font-size: 12px; color: var(--muted)"></div>
    </div>
    <div style="display: flex; flex: 1; min-height: 0">
      <div id="messages"></div>
      <div id="rightbar">
        <div style="font-weight: 800; margin-bottom: 10px">Users üë•</div>
        <div id="userList"></div>
      </div>
    </div>
    <div
      id="replyPreview"
      style="
        display: none;
        padding: 8px 12px;
        background: var(--panel);
        border-top: 1px solid var(--card);
      "
    >
      <span
        onclick="cancelReply()"
        style="float: right; cursor: pointer; font-weight: bold"
        >‚úñÔ∏è</span
      >
      Replying to <strong id="replyUser"></strong>:
      <span id="replyText" style="opacity: 0.6"></span>
    </div>
    <div id="bottomBar">
      <textarea
        id="msgInput"
        placeholder="Type a message..."
        rows="1"
        oninput="autoExpand(this)"
        onkeydown="
          if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            sendMessage();
          }
        "
      ></textarea>
      <button
        id="sendBtn"
        onclick="sendMessage()"
        style="align-self: flex-end"
      >
        Send
      </button>
    </div>
  </div>
</div>

<button id="scrollBtn">‚¨áÔ∏è</button>

<div id="modalOverlay">
  <div class="modalCard">
    <h3 id="modalTitle"></h3>
    <div
      id="modalSubtitle"
      style="font-size: 14px; color: var(--muted); margin-bottom: 10px"
    ></div>
    <div id="modalCustomContent"></div>
    <input
      id="modalInput"
      autocomplete="off"
      style="
        display: none;
        padding: 10px;
        border-radius: 8px;
        background: var(--input-bg);
        color: var(--text);
        border: none;
      "
    />
    <div
      class="modalActions"
      style="
        display: flex;
        gap: 8px;
        justify-content: flex-end;
        margin-top: 10px;
      "
    >
      <button
        id="modalConfirmBtn"
        onclick="submitModal()"
        style="
          padding: 8px 16px;
          background: var(--accent);
          color: white;
          border-radius: 5px;
          border: none;
          cursor: pointer;
        "
      >
        OK
      </button>
      <button
        id="modalCancelBtn"
        onclick="closeModal()"
        style="
          padding: 8px 16px;
          background: var(--card);
          color: white;
          border-radius: 5px;
          border: none;
          cursor: pointer;
        "
      >
        Cancel
      </button>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
  const _0x4f2d = (s) => decodeURIComponent(escape(atob(s)));
  const firebaseConfig = {
    apiKey: _0x4f2d("QUl6YVN5RGJ5cnF6Y1o0Vms1N3hCTlZEek51UmVyUWFCeDJwMUww"),
    authDomain: _0x4f2d("aHRtbGNoYXQtOGIyYzUuZmlyZWJhc2VhcHAuY29t"),
    databaseURL: _0x4f2d("aHR0cHM6Ly9odG1sY2hhdC04YjJjNS1kZWZhdWx0LXJ0ZGIuZmlyZWJhc2Vpby5jb20="),
    projectId: _0x4f2d("aHRtbGNoYXQtOGIyYzU="),
    storageBucket: _0x4f2d("aHRtbGNoYXQtOGIyYzUuZmlyZWJhc2VzdG9yYWdlLmFwcA=="),
    messagingSenderId: _0x4f2d("Njc4NDEzMTMxMzMw"),
    appId: _0x4f2d("MTo2Nzg0MTMxMzEzMzA6d2ViOjc2ODVjOWU5MDRiOGY0ZDA1NWQ3ZGI="),
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  let username = "";
  let currentChannel = "";
  let currentServer = "general";
  let myStatus = "online";
  let lastMsgTime = 0;
  let replyingToId = null;
  let modalCallback = null;
  let lastMessageMeta = { user: null, ts: 0 };
  let autoScroll = true;
  let compactView = false;
  let lightTheme = false;
  let userSettings = { desktopNotifications: true, profilePic: "" };
  let loginTime = Date.now();
  let mentionCounts = {};
  let channelsData = [];
  let serversData = [];
  let BLACKLIST = [];

  const PROFILE_PICS = [
    "https://cdn.jsdelivr.net/gh/shayderrr/assetscool@main/profilepics/2eb1cabc77e388e6ad66e2910770e42b.jpg",
    "https://cdn.jsdelivr.net/gh/shayderrr/assetscool@main/profilepics/612aebd3541ee7d6cef987e86e7c1a38.jpg",
    "https://cdn.jsdelivr.net/gh/shayderrr/assetscool@main/profilepics/f4eedaef776decc782fffd078b7f46a3.jpg"
  ];

  function containsBlacklistedWord(text) {
    if (!text || BLACKLIST.length === 0) return false;
    const lowerText = text.toLowerCase();
    return BLACKLIST.some(word => {
      const lowerWord = word.toLowerCase();
      return lowerText.includes(lowerWord);
    });
  }

  function autoMod(text) {
    let p = text;
    if (p.length > 500) p = p.substring(0, 500) + "...";
    if (/(.)\1{8,}/.test(p)) return "ü§ê (Flooding blocked)";
    if (BLACKLIST.length === 0) return p;
    BLACKLIST.forEach((word) => {
      const safeWord = word.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
      const regex = new RegExp(`\\b${safeWord}\\b`, "gi");
      p = p.replace(regex, "ü§ê");
    });
    const capsCount = (p.match(/[A-Z]/g) || []).length;
    if (capsCount > p.length * 0.7 && p.length > 5) p = p.toLowerCase();
    return p;
  }

  function parseMentions(text) {
    if (!text) return "";
    let safeText = escapeHTML(text);
    safeText = safeText.replace(
      /@([a-zA-Z0-9_]+)/g,
      (match, mentionedUser) => {
        const isMe = mentionedUser === username;
        return `<span class="mention-highlight ${isMe ? "me" : ""}" data-user="${mentionedUser}">${match}</span>`;
      },
    );
    return safeText;
  }

  function uidColor(name) {
    if (!name) return "#7289da";
    const palette = ["#e67e22", "#e74c3c", "#9b59b6", "#16a085", "#f39c12", "#3498db", "#2ecc71", "#d35400", "#1abc9c", "#8e44ad"];
    let h = 0;
    for (let i = 0; i < name.length; i++) h = (h << 5) - h + name.charCodeAt(i);
    h = Math.abs(h);
    return palette[h % palette.length];
  }

  function escapeHTML(t) {
    if (!t) return "";
    return t.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
  }

  function initials(name) {
    return name ? name.trim().charAt(0).toUpperCase() : "?";
  }

  function nowHHMM(ts) {
    const d = ts ? new Date(ts) : new Date();
    return `${String(d.getHours()).padStart(2, "0")}:${String(d.getMinutes()).padStart(2, "0")}`;
  }

  function generateAvatarUrl(user) {
    const canvas = document.createElement("canvas");
    canvas.width = 128;
    canvas.height = 128;
    const ctx = canvas.getContext("2d");
    ctx.fillStyle = uidColor(user);
    ctx.fillRect(0, 0, 128, 128);
    ctx.fillStyle = "#FFFFFF";
    ctx.font = "bold 72px sans-serif";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText(initials(user), 64, 64);
    return canvas.toDataURL();
  }

  function toggleTheme() {
    lightTheme = !lightTheme;
    document.documentElement.classList.toggle("light", lightTheme);
    const btn = document.getElementById("themeBtn");
    if (btn) btn.textContent = lightTheme ? "‚òÄÔ∏è" : "üåô";
  }

  function switchAuth(mode) {
    const isS = mode === "signup";
    document.getElementById("loginTab").classList.toggle("active", mode === "login");
    document.getElementById("signupTab").classList.toggle("active", isS);
    document.getElementById("authTitle").textContent = isS ? "Create an account" : "Welcome back!";
    document.getElementById("authSubtext").textContent = isS ? "Join our community today!" : "We're so excited to see you again!";
    document.getElementById("authConfirmContainer").style.display = isS ? "block" : "none";
    document.getElementById("passwordRequirements").style.display = isS ? "flex" : "none";
    const footer = document.getElementById("authFooter");
    if (isS) {
      footer.innerHTML = 'Already have an account? <a href="#" onclick="switchAuth(\'login\'); return false;" style="color: var(--accent); text-decoration: none;">Login</a>';
    } else {
      footer.innerHTML = 'Need an account? <a href="#" onclick="switchAuth(\'signup\'); return false;" style="color: var(--accent); text-decoration: none;">Register</a>';
    }
    document.getElementById("submitBtn").textContent = isS ? "Continue" : "Login";
    document.getElementById("authMessage").textContent = "";
  }

  async function submitAuth() {
    const u = document.getElementById("authUsername").value.trim();
    const p = document.getElementById("authPassword").value;
    const c = document.getElementById("authConfirm").value;
    if (!u || !p) return;
    const isSignup = document.getElementById("signupTab").classList.contains("active");
    if (isSignup) {
      if (u.length < 3) return (document.getElementById("authMessage").textContent = "Username too short");
      if (containsBlacklistedWord(u)) return (document.getElementById("authMessage").textContent = "Username contains inappropriate content");
      if (p.length < 8) return (document.getElementById("authMessage").textContent = "Password too weak");
      if (p !== c) return (document.getElementById("authMessage").textContent = "Passwords don't match");
      const snap = await db.ref("users/" + u).once("value");
      if (snap.exists()) return (document.getElementById("authMessage").textContent = "Username taken");
      await db.ref("users/" + u).set({ password: p, settings: { desktopNotifications: true, profilePic: "" }, servers: { general: true } });
    } else {
      const snap = await db.ref("users/" + u).once("value");
      if (!snap.exists() || snap.val().password !== p) return (document.getElementById("authMessage").textContent = "Invalid login");
    }
    username = u;
    afterLogin();
  }

  async function afterLogin() {
    document.getElementById("authDiv").style.display = "none";
    document.getElementById("app").style.display = "flex";
    document.getElementById("meLabel").textContent = "üë§ " + username;
    if ("Notification" in window) Notification.requestPermission();
    
    const userSnap = await db.ref(`users/${username}`).once("value");
    const userData = userSnap.val();
    if (userData && userData.settings) {
      userSettings = userData.settings;
    }
    
    await ensureGeneralServer();
    await ensureUserInGeneralServer();
    loadServers();
    loadChannels();
    startPresence();
    listenToNotifs();
    attachScrollHandler();
    loadUserList();
  }

  async function ensureGeneralServer() {
    const snap = await db.ref("servers/general").once("value");
    if (!snap.exists()) {
      await db.ref("servers/general").set({
        name: "General",
        owner: "system",
        createdAt: Date.now(),
        channels: { general: true },
        roles: {
          everyone: {
            name: "Everyone",
            color: "#99aab5",
            permissions: {
              sendMessages: true,
              readMessages: true
            }
          }
        }
      });
      await db.ref("channels/general__general").set({
        serverId: "general",
        name: "general",
        createdBy: "system",
        type: "text"
      });
    }
  }

  async function ensureUserInGeneralServer() {
    await db.ref(`users/${username}/servers/general`).set(true);
    await db.ref(`servers/general/members/${username}`).set({
      joinedAt: Date.now(),
      roles: ["everyone"]
    });
  }

  function logout() {
    location.reload();
  }

  async function loadExternalBlacklist() {
    try {
      const url = _0x4f2d("aHR0cHM6Ly9jZG4uanNkZWxpdnIubmV0L2doL2hvdGhvc3Q1OS9hdXRvbW9kLWxpc3RAbWFzdGVyL2xpc3QudHh0");
      const response = await fetch(url);
      const base64String = await response.text();
      const decodedText = atob(base64String.trim());
      BLACKLIST = JSON.parse("[" + decodedText + "]");
    } catch (err) {}
  }

  function showModal(title, sub, callback, options = {}) {
    modalCallback = callback;
    document.getElementById("modalTitle").textContent = title;
    document.getElementById("modalSubtitle").textContent = sub;
    document.getElementById("modalOverlay").style.display = "flex";
    const input = document.getElementById("modalInput");
    input.style.display = options.showInput ? "block" : "none";
    input.value = "";
    input.placeholder = options.placeholder || "";
    const content = document.getElementById("modalCustomContent");
    content.innerHTML = "";
    if (options.customHTML) content.appendChild(options.customHTML);
    if (options.showInput) input.focus();
    document.getElementById("modalCancelBtn").style.display = options.hideCancel ? "none" : "block";
  }

  function closeModal() {
    document.getElementById("modalOverlay").style.display = "none";
  }

  function submitModal() {
    const input = document.getElementById("modalInput");
    const value = input.style.display !== "none" ? input.value.trim() : null;
    if (modalCallback) modalCallback(value !== null ? value || true : true);
    closeModal();
  }

  async function loadServers() {
    const userSnap = await db.ref(`users/${username}/servers`).once("value");
    const userServers = userSnap.val() || {};
    
    db.ref("servers").on("value", (snap) => {
      serversData = [];
      snap.forEach((srv) => {
        if (userServers[srv.key]) {
          serversData.push({ id: srv.key, ...srv.val() });
        }
      });
      renderServers();
    });
  }

  function renderServers() {
    const list = document.getElementById("serverList");
    list.innerHTML = "";
    const dmIcon = document.createElement("div");
    dmIcon.className = "serverIcon" + (currentServer === "dms" ? " active" : "");
    dmIcon.innerHTML = "üí¨";
    dmIcon.title = "Direct Messages";
    dmIcon.onclick = () => switchServer("dms");
    list.appendChild(dmIcon);
    const sep = document.createElement("div");
    sep.style = "width: 32px; height: 2px; background: rgba(255,255,255,0.1); margin: 8px auto;";
    list.appendChild(sep);
    serversData.forEach((srv) => {
      const icon = document.createElement("div");
      icon.className = "serverIcon" + (srv.id === currentServer ? " active" : "");
      icon.textContent = srv.name.charAt(0).toUpperCase();
      icon.onclick = () => switchServer(srv.id);
      icon.title = srv.name;
      list.appendChild(icon);
    });
    const addBtn = document.createElement("div");
    addBtn.className = "serverIcon";
    addBtn.innerHTML = "+";
    addBtn.title = "Create or Join Server";
    addBtn.onclick = showServerJoinCreate;
    list.appendChild(addBtn);
  }

  async function switchServer(serverId) {
    currentServer = serverId;
    const msgContainer = document.getElementById("messages");
    
    if (serverId === "dms") {
      document.getElementById("serverName").textContent = "Direct Messages";
      document.getElementById("sidebarHeader").querySelector("button[onclick='showServerSettingsModal()']").style.display = "none";
      document.getElementById("createChannelBtn").style.display = "none";
      msgContainer.innerHTML = `<div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; color:var(--muted); text-align:center;"><h2>Direct Messages</h2><p>Click on a user in the sidebar to start a conversation!</p></div>`;
    } else {
      const snap = await db.ref(`servers/${serverId}`).once("value");
      const serverData = snap.val();
      document.getElementById("serverName").textContent = serverData ? serverData.name : serverId;
      document.getElementById("sidebarHeader").querySelector("button[onclick='showServerSettingsModal()']").style.display = "";
      document.getElementById("createChannelBtn").style.display = "";
      msgContainer.innerHTML = `<div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; color:var(--muted); text-align:center;"><h2>Welcome to ${serverData ? serverData.name : serverId}</h2><p>Select a channel on the left to start talking!</p></div>`;
    }
    
    renderServers();
    loadChannels();
    loadUserList();
  }

  function loadUserList() {
    const list = document.getElementById("userList");
    if (currentServer === "dms" || currentServer === "general") {
      db.ref("users").once("value", (uSnap) => {
        db.ref("presence").on("value", async (pSnap) => {
          const presence = pSnap.val() || {};
          const users = uSnap.val() || {};
          const userArray = [];
          for (let uname in users) {
            const userData = users[uname];
            userArray.push({
              name: uname,
              status: presence[uname]?.status || "offline",
              role: null,
              profilePic: userData?.settings?.profilePic || ""
            });
          }
          const statusOrder = { online: 0, away: 1, offline: 2 };
          userArray.sort((a, b) => statusOrder[a.status] - statusOrder[b.status] || a.name.localeCompare(b.name));
          list.innerHTML = "";
          userArray.forEach((user) => {
            const row = document.createElement("div");
            row.className = "userRow";
            const avatarContent = user.profilePic ? 
              `<img src="${user.profilePic}" style="width:100%; height:100%; object-fit:cover; border-radius:50%;">` : 
              initials(user.name);
            const color = user.profilePic ? "transparent" : uidColor(user.name);
            row.innerHTML = `<div class="avatar" style="background:${color}; width:34px; height:34px; font-size:14px;">${avatarContent}</div>
                                       <div class="userName">${user.name}</div>
                                       <div class="statusDot status-${user.status}"></div>`;
            row.onclick = () => createDMWith(user.name);
            list.appendChild(row);
          });
        });
      });
    } else {
      db.ref(`servers/${currentServer}/members`).on("value", async (membersSnap) => {
        const members = membersSnap.val() || {};
        db.ref("presence").on("value", async (pSnap) => {
          const presence = pSnap.val() || {};
          const userArray = [];
          for (let uname in members) {
            const userSnap = await db.ref(`users/${uname}`).once("value");
            const userData = userSnap.val();
            const memberData = members[uname];
            const userRoles = memberData.roles || ["everyone"];
            const serverSnap = await db.ref(`servers/${currentServer}/roles`).once("value");
            const roles = serverSnap.val() || {};
            let highestRole = roles["everyone"];
            userRoles.forEach(roleId => {
              if (roles[roleId]) highestRole = roles[roleId];
            });
            userArray.push({
              name: uname,
              status: presence[uname]?.status || "offline",
              role: highestRole,
              profilePic: userData?.settings?.profilePic || ""
            });
          }
          const statusOrder = { online: 0, away: 1, offline: 2 };
          userArray.sort((a, b) => statusOrder[a.status] - statusOrder[b.status] || a.name.localeCompare(b.name));
          list.innerHTML = "";
          userArray.forEach((user) => {
            const row = document.createElement("div");
            row.className = "userRow";
            const avatarContent = user.profilePic ? 
              `<img src="${user.profilePic}" style="width:100%; height:100%; object-fit:cover; border-radius:50%;">` : 
              initials(user.name);
            const roleColor = user.role?.color || uidColor(user.name);
            row.innerHTML = `<div class="avatar" style="background:${user.profilePic ? 'transparent' : roleColor}; width:34px; height:34px; font-size:14px;">${avatarContent}</div>
                                       <div class="userName" style="color:${roleColor}">${user.name}</div>
                                       <div class="statusDot status-${user.status}"></div>`;
            row.onclick = () => createDMWith(user.name);
            list.appendChild(row);
          });
        });
      });
    }
  }

  async function loadChannels() {
    if (currentServer === "dms") {
      db.ref("channels").on("value", (snap) => {
        channelsData = [];
        snap.forEach((ch) => {
          const data = ch.val();
          const isDM = ch.key.startsWith("dm__");
          if (isDM) {
            const parts = ch.key.replace("dm__", "").split("__");
            if (!parts.includes(username)) return;
            if (data.type === "dm" && data.members && data.members[username] && data.members[username].active === false) return;
            channelsData.push({ id: ch.key, ...data });
          }
        });
        renderChannels();
      });
    } else {
      const serverSnap = await db.ref(`servers/${currentServer}/channels`).once("value");
      const serverChannels = serverSnap.val() || {};
      db.ref("channels").on("value", (snap) => {
        channelsData = [];
        snap.forEach((ch) => {
          const data = ch.val();
          if (data.serverId === currentServer && serverChannels[data.name]) {
            channelsData.push({ id: ch.key, ...data });
          }
        });
        renderChannels();
      });
    }
  }

  function renderChannels() {
    const list = document.getElementById("channelList");
    list.innerHTML = "";
    channelsData.forEach((ch) => {
      const row = document.createElement("div");
      row.className = "channelRow" + (ch.id === currentChannel ? " active" : "");
      row.dataset.id = ch.id;
      let displayTitle = "";
      const isDM = ch.id.startsWith("dm__");
      if (isDM) {
        const parts = ch.id.replace("dm__", "").split("__");
        displayTitle = "üë§ " + (parts.find((p) => p !== username) || parts[0]);
      } else {
        displayTitle = "# " + ch.name;
      }
      const mentionCount = mentionCounts[ch.id] || 0;
      const badgeHTML = mentionCount > 0 ? `<div class="badge">${mentionCount}</div>` : "";
      row.innerHTML = `<div class="channelLeft" style="display:flex; align-items:center; gap:8px;">
                                <span>${escapeHTML(displayTitle)}</span>
                                ${badgeHTML}
                             </div>`;
      if (currentServer !== "general" || isDM) {
        const btn = document.createElement("span");
        btn.innerHTML = "‚úñÔ∏è";
        btn.className = "close-dm-btn";
        btn.onclick = (e) => {
          e.stopPropagation();
          if (isDM) {
            closeDM(ch.id);
          } else {
            deleteChannel(ch.id, ch.name);
          }
        };
        row.appendChild(btn);
      }
      row.onclick = () => joinChannel(ch.id);
      list.appendChild(row);
    });
  }

  function autoExpand(el) {
    el.style.height = "auto";
    el.style.height = el.scrollHeight + "px";
    if (el.scrollHeight > 200) {
      el.style.overflowY = "auto";
    } else {
      el.style.overflowY = "hidden";
    }
  }

  async function joinChannel(name) {
    if (currentChannel) db.ref("messages/" + currentChannel).off();
    currentChannel = name;
    renderChannels();
    db.ref(`users/${username}/notifications`).once("value", (snap) => {
      snap.forEach((n) => {
        if (n.val().channel === name) n.ref.remove();
      });
    });
    const chSnap = await db.ref("channels/" + name).once("value");
    const chData = chSnap.val();
    let displayTitle = "";
    const isDM = name.startsWith("dm__");
    if (isDM) {
      const parts = name.replace("dm__", "").split("__");
      displayTitle = "üë§ " + (parts.find((p) => p !== username) || parts[0]);
    } else {
      displayTitle = chData ? "# " + chData.name : name;
    }
    document.getElementById("chatTitle").textContent = displayTitle;
    document.getElementById("messages").innerHTML = "";
    lastMessageMeta = { user: null, ts: 0 };
    const ref = db.ref("messages/" + name);
    ref.on("child_added", (snap) => appendMessage(snap.val(), snap.key));
    ref.on("child_removed", (snap) => {
      const el = document.querySelector(`.message[data-id="${snap.key}"]`);
      if (el) el.remove();
    });
    ref.on("child_changed", (snap) => {
      const el = document.querySelector(`.message[data-id="${snap.key}"] .msgText`);
      if (el) el.innerHTML = parseMentions(snap.val().text);
    });
    setTimeout(() => {
        const container = document.getElementById("messages");
        container.scrollTop = container.scrollHeight;
        autoScroll = true;
    }, 300);
  }

  async function createDMWith(other) {
    if (other === username) return;
    const id = [username, other].sort().join("__");
    const dmId = "dm__" + id;
    const snap = await db.ref("channels/" + dmId).once("value");
    if (!snap.exists()) {
      const members = {};
      members[username] = { active: true };
      members[other] = { active: true };
      await db.ref("channels/" + dmId).set({ 
        name: other,
        type: "dm", 
        members: members 
      });
    } else {
      db.ref(`channels/${dmId}/members/${username}`).update({ active: true });
    }
    if (currentServer !== "dms") {
      await switchServer("dms");
    }
    joinChannel(dmId);
  }

  function closeDM(id) {
    db.ref(`channels/${id}/members/${username}`).update({ active: false });
    if (currentChannel === id) currentChannel = "";
    loadChannels();
  }

  async function hasPermission(permission) {
    if (currentServer === "dms") return true;
    if (currentServer === "general" && username === "system") return true;
    const serverSnap = await db.ref(`servers/${currentServer}`).once("value");
    const serverData = serverSnap.val();
    if (serverData.owner === username) return true;
    const memberSnap = await db.ref(`servers/${currentServer}/members/${username}`).once("value");
    const memberData = memberSnap.val();
    if (!memberData) return false;
    const userRoles = memberData.roles || ["everyone"];
    const roles = serverData.roles || {};
    for (let roleId of userRoles) {
      if (roles[roleId] && roles[roleId].permissions && roles[roleId].permissions[permission]) {
        return true;
      }
    }
    return false;
  }

  async function deleteChannel(channelId, channelName) {
    if (currentServer === "general") {
      showModal("Error", "Cannot delete channels in the General server", null, { showInput: false, hideCancel: true });
      return;
    }
    const canDelete = await hasPermission("deleteChannels");
    if (!canDelete) {
      showModal("No Permission", "You don't have permission to delete channels", null, { showInput: false, hideCancel: true });
      return;
    }
    showModal("Delete Channel", `Delete #${channelName}?`, async (conf) => {
      if (conf) {
        await db.ref(`channels/${channelId}`).remove();
        await db.ref(`servers/${currentServer}/channels/${channelName}`).remove();
        await db.ref(`messages/${channelId}`).remove();
        if (currentChannel === channelId) currentChannel = "";
      }
    }, { showInput: false });
  }

  function appendMessage(m, id) {
    const container = document.getElementById("messages");
    const within = m.ts - lastMessageMeta.ts < 300000;
    const isGrouped = lastMessageMeta.user === m.user && within && !m.replyTo;
    const div = document.createElement("div");
    div.className = "message show" + (isGrouped ? " grouped" : "");
    div.dataset.id = id;
    let roleColor = uidColor(m.user);
    const headerHTML = !isGrouped ? `<div class="msgHeader"><span class="username" style="color:${roleColor}">${m.user}</span><span class="role-placeholder"></span><span class="timestamp">${nowHHMM(m.ts)}</span></div>` : '';
    
    // IMMEDIATE APPEND to ensure chronological order
    div.innerHTML = `<div class="avatar" style="background:${roleColor}">${initials(m.user)}</div>
            <div class="msgBody"><div class="reply-placeholder"></div>
                ${headerHTML}
                <div class="msgText">${parseMentions(m.text)}</div>
            </div>
            <div class="message-menu">
                <div class="menu-item" onclick="replyToUI('${id}', '${m.user}', '${m.text.replace(/'/g, "\\'")}')">‚Ü©Ô∏è</div>
                ${m.user === username ? `<div class="menu-item" onclick="showEditUI('${id}')">‚úèÔ∏è</div><div class="menu-item" onclick="deleteMsgUI('${id}')">üóëÔ∏è</div>` : ""}
            </div>`;
    
    container.appendChild(div);
    if (autoScroll) container.scrollTop = container.scrollHeight;
    lastMessageMeta = { user: m.user, ts: m.ts };

    // Fetch ASYNC data (replies, profile pics, roles) after message is in DOM
    if (m.replyTo) {
      db.ref(`messages/${currentChannel}/${m.replyTo}`).once("value").then(rSnap => {
        if (rSnap.exists()) {
          div.querySelector(".reply-placeholder").innerHTML = `<div class="reply-quote" onclick="jumpTo('${m.replyTo}')">‚Ü©Ô∏è @${rSnap.val().user}: ${rSnap.val().text.substring(0, 40)}</div>`;
          if (autoScroll) container.scrollTop = container.scrollHeight;
        }
      });
    }

    db.ref(`users/${m.user}/settings/profilePic`).once("value").then(pSnap => {
      const pic = pSnap.val();
      if (pic) {
        const av = div.querySelector(".avatar");
        av.style.background = "transparent";
        av.innerHTML = `<img src="${pic}">`;
      }
    });

    if (currentServer !== "dms") {
        db.ref(`servers/${currentServer}`).once("value").then(serverSnap => {
            const serverData = serverSnap.val();
            db.ref(`servers/${currentServer}/members/${m.user}`).once("value").then(memberSnap => {
                const memberData = memberSnap.val();
                if (!memberData) return;
                const userRoles = memberData?.roles || ["everyone"];
                const roles = serverData.roles || {};
                let highestRole = roles["everyone"];
                userRoles.forEach(roleId => { if (roles[roleId]) highestRole = roles[roleId]; });
                const roleColorFinal = highestRole?.color || uidColor(m.user);
                const roleName = highestRole?.name !== "Everyone" ? highestRole.name : "";
                const uEl = div.querySelector(".username");
                if (uEl) uEl.style.color = roleColorFinal;
                if (roleName) {
                    const rp = div.querySelector(".role-placeholder");
                    if (rp) rp.innerHTML = `<span class="role-badge" style="background:${roleColorFinal}20; color:${roleColorFinal}">${roleName}</span>`;
                }
            });
        });
    }
  }

  async function sendMessage() {
    const input = document.getElementById("msgInput");
    let text = input.value.trim();
    if (!text || !currentChannel) return;
    const now = Date.now();
    if (now - lastMsgTime < 300) {
      showModal("‚è≥ Rate Limit", "Please wait 0.3 seconds between messages.", null, { showInput: false, hideCancel: true });
      return;
    }
    const canSend = await hasPermission("sendMessages");
    if (!canSend) {
      showModal("No Permission", "You don't have permission to send messages", null, { showInput: false, hideCancel: true });
      return;
    }
    text = autoMod(text);
    const msgRef = db.ref("messages/" + currentChannel).push();
    await msgRef.set({ user: username, text: text, ts: now, replyTo: replyingToId });
    const mentions = text.match(/@([a-zA-Z0-9_]+)/g);
    if (mentions) {
      const uniqueMentions = [...new Set(mentions.map((m) => m.substring(1)))];
      uniqueMentions.forEach(async (mentionedUser) => {
        if (mentionedUser === username) return;
        const userSnap = await db.ref(`users/${mentionedUser}`).once("value");
        if (userSnap.exists()) {
          const notifPayload = { from: username, channel: currentChannel, messageId: msgRef.key, text: text.substring(0, 100), ts: now };
          db.ref(`users/${mentionedUser}/notifications`).push(notifPayload);
        }
      });
    }
    input.value = "";
    autoExpand(input);
    lastMsgTime = now;
    cancelReply();
  }

  function showSettingsModal() {
    const d = document.createElement("div");
    d.style.textAlign = "left";
    const picSection = document.createElement("div");
    picSection.className = "settings-section";
    picSection.innerHTML = '<span class="settings-label">Profile Picture</span><div style="display:flex; gap:15px; justify-content:center; margin:15px 0;">';
    PROFILE_PICS.forEach((url, idx) => {
      const img = document.createElement("img");
      img.src = url;
      img.className = "profile-pic-option" + (userSettings.profilePic === url ? " selected" : "");
      img.onclick = async () => {
        userSettings.profilePic = url;
        await db.ref(`users/${username}/settings/profilePic`).set(url);
        document.querySelectorAll(".profile-pic-option").forEach(i => i.classList.remove("selected"));
        img.classList.add("selected");
      };
      picSection.querySelector("div").appendChild(img);
    });
    const clearBtn = document.createElement("button");
    clearBtn.textContent = "Clear";
    clearBtn.className = "discord-btn";
    clearBtn.style.width = "100%";
    clearBtn.style.marginTop = "10px";
    clearBtn.onclick = async () => {
      userSettings.profilePic = "";
      await db.ref(`users/${username}/settings/profilePic`).set("");
      document.querySelectorAll(".profile-pic-option").forEach(i => i.classList.remove("selected"));
    };
    picSection.appendChild(clearBtn);
    d.innerHTML = `
    <div id="settingsStatus" style="font-weight:bold; font-size:12px; margin-bottom:10px;"></div>
    <div class="settings-section">
        <span class="settings-label">App Settings</span>
        <div style="display:flex; justify-content:space-between; align-items:center; background: var(--bg-secondary); padding:12px; border-radius:8px;">
            <div>
                <div style="font-weight:600;">Theme Mode</div>
                <div style="font-size:12px; color: var(--text-muted);">Switch between light and dark appearance</div>
            </div>
            <button class="discord-btn" onclick="toggleTheme()" style="background: var(--card);">üåì Toggle</button>
        </div>
    </div>
    <div class="settings-section">
        <span class="settings-label">Notifications</span>
        <div style="display:flex; justify-content:space-between; align-items:center; background: var(--bg-secondary); padding:12px; border-radius:8px;">
            <div>
                <div style="font-weight:600;">Desktop Notifications</div>
                <div style="font-size:12px; color: var(--text-muted);">Get notified of mentions on your desktop</div>
            </div>
            <button class="discord-btn" id="notifToggleBtn" onclick="toggleDesktopNotifications()" style="background:${userSettings.desktopNotifications ? "var(--accent)" : "var(--card)"};">
                ${userSettings.desktopNotifications ? "Enabled" : "Disabled"}
            </button>
        </div>
    </div>
    <div class="settings-section">
        <span class="settings-label">Password and Authentication</span>
        <div class="settings-input-group">
            <input id="currentPassword" type="password" placeholder="Current Password">
        </div>
        <div class="settings-input-group">
            <input id="newPassword" type="password" placeholder="New Password">
        </div>
        <div class="settings-input-group" style="margin-bottom:10px;">
            <input id="confirmPassword" type="password" placeholder="Confirm New Password">
        </div>
        <div class="settings-req-box">
            <div id="settings-req-length" class="requirement">‚úÖ 8+ characters</div>
            <div id="settings-req-upper" class="requirement">‚úÖ One uppercase letter</div>
            <div id="settings-req-num" class="requirement">‚úÖ One number</div>
        </div>
        <button class="discord-btn" onclick="changePassword()">Change Password</button>
    </div>
    <div class="settings-section">
        <span class="settings-label">About</span>
        <div style="font-size:14px;">Developed by <strong style="color:var(--accent)">hothost59, shxyder</strong></div>
        <div style="font-size:12px; color: var(--text-muted); margin-top:4px;">Version 2.0.0 ‚Ä¢ Enhanced Release Feb 2026</div>
    </div>
    <div class="danger-zone" style="border-color: #ed4245;">
        <span class="settings-label" style="color:#ed4245;">Delete Account</span>
        <p style="font-size:12px; color: var(--text-muted); margin: 8px 0;">Once you delete your account, there is no going back. Please be certain.</p>
        <button class="discord-btn" style="background:#ed4245;" onclick="deleteAccountUI()">Delete Account</button>
    </div>
`;
    d.insertBefore(picSection, d.firstChild);
    showModal("User Settings", "", null, { customHTML: d, showInput: false });
    const nP = document.getElementById("newPassword");
    if (nP)
      nP.oninput = () => {
        const v = nP.value;
        document.getElementById("settings-req-length").classList.toggle("valid", v.length >= 8);
        document.getElementById("settings-req-upper").classList.toggle("valid", /[A-Z]/.test(v));
        document.getElementById("settings-req-num").classList.toggle("valid", /[0-9]/.test(v));
      };
  }

  async function showServerSettingsModal() {
    const serverSnap = await db.ref(`servers/${currentServer}`).once("value");
    const serverData = serverSnap.val();
    if (currentServer === "general") {
      showModal("Server Settings", "The General server cannot be modified", null, { showInput: false, hideCancel: true });
      return;
    }
    if (serverData.owner !== username) {
      showModal("No Permission", "Only the server owner can access server settings", null, { showInput: false, hideCancel: true });
      return;
    }
    const d = document.createElement("div");
    d.innerHTML = `
      <div class="settings-section">
        <span class="settings-label">Server Info</span>
        <div style="margin-bottom:10px;">
          <strong>Server ID:</strong> ${currentServer}<br>
          <strong>Owner:</strong> ${serverData.owner}
        </div>
      </div>
      <div class="settings-section">
        <span class="settings-label">Invite Code</span>
        <div style="background: var(--bg-secondary); padding:12px; border-radius:8px; margin:10px 0;">
          <code id="inviteCode" style="font-size:16px; color:var(--accent);">${serverData.inviteCode || "No invite code"}</code>
          <button class="discord-btn" onclick="copyInviteCode('${serverData.inviteCode}')" style="margin-left:10px;">Copy</button>
        </div>
        <button class="discord-btn" onclick="generateInviteCode()">Generate New Invite</button>
      </div>
      <div class="settings-section">
        <span class="settings-label">Roles</span>
        <div id="rolesList"></div>
        <button class="discord-btn" onclick="showCreateRoleUI()">Create Role</button>
      </div>
      <div class="settings-section">
        <span class="settings-label">Members</span>
        <div id="membersList"></div>
      </div>
      <div class="danger-zone" style="border-color: #ed4245; margin-top:20px;">
        <span class="settings-label" style="color:#ed4245;">Delete Server</span>
        <p style="font-size:12px; color: var(--text-muted); margin: 8px 0;">Permanently delete this server and all its channels. This cannot be undone.</p>
        <button class="discord-btn" style="background:#ed4245;" onclick="deleteServerUI()">Delete Server</button>
      </div>
    `;
    showModal("Server Settings - " + serverData.name, "", null, { customHTML: d, showInput: false });
    const rolesList = document.getElementById("rolesList");
    const roles = serverData.roles || {};
    for (let roleId in roles) {
      if (roleId === "everyone") continue;
      const role = roles[roleId];
      const roleDiv = document.createElement("div");
      roleDiv.style = "background: var(--bg-secondary); padding:10px; border-radius:5px; margin:5px 0;";
      roleDiv.innerHTML = `
        <strong style="color:${role.color}">${role.name}</strong>
        <button class="discord-btn" onclick="deleteRole('${roleId}')" style="float:right; background:#e74c3c; padding:5px 10px;">Delete</button>
      `;
      rolesList.appendChild(roleDiv);
    }
    const membersList = document.getElementById("membersList");
    const members = serverData.members || {};
    for (let member in members) {
      const memberDiv = document.createElement("div");
      memberDiv.style = "background: var(--bg-secondary); padding:10px; border-radius:5px; margin:5px 0; display:flex; justify-content:space-between; align-items:center;";
      memberDiv.innerHTML = `
        <strong>${member}</strong>
        <div>
          <button class="discord-btn" onclick="showMemberManageUI('${member}')" style="padding:5px 10px; margin-right:5px;">Manage</button>
          ${member !== username ? `<button class="discord-btn" onclick="kickMember('${member}')" style="padding:5px 10px; background:#e74c3c;">Kick</button>` : ""}
        </div>
      `;
      membersList.appendChild(memberDiv);
    }
  }

  async function deleteServerUI() {
    const serverToDelete = currentServer;
    const serverSnap = await db.ref(`servers/${serverToDelete}`).once("value");
    const serverData = serverSnap.val();
    closeModal();
    showModal("Delete Server", "Type the server name to confirm deletion:", async (confirmation) => {
      if (!confirmation) return;
      if (confirmation === serverData.name) {
        const channelsSnap = await db.ref("channels").once("value");
        const deletePromises = [];
        channelsSnap.forEach((ch) => {
          const chData = ch.val();
          if (chData.serverId === serverToDelete) {
            deletePromises.push(db.ref(`channels/${ch.key}`).remove());
            deletePromises.push(db.ref(`messages/${ch.key}`).remove());
          }
        });
        const members = serverData.members || {};
        for (let member in members) {
          deletePromises.push(db.ref(`users/${member}/servers/${serverToDelete}`).remove());
        }
        deletePromises.push(db.ref(`servers/${serverToDelete}`).remove());
        await Promise.all(deletePromises);
        serversData = serversData.filter(s => s.id !== serverToDelete);
        await switchServer("general");
        showModal("Success", "Server deleted successfully", null, { showInput: false, hideCancel: true });
      } else {
        showModal("Error", "Server name doesn't match. Deletion cancelled.", null, { showInput: false, hideCancel: true });
      }
    }, { showInput: true, placeholder: serverData.name });
  }

  async function generateInviteCode() {
    const code = Math.random().toString(36).substring(2, 10).toUpperCase();
    await db.ref(`servers/${currentServer}/inviteCode`).set(code);
    document.getElementById("inviteCode").textContent = code;
  }

  function copyInviteCode(code) {
    navigator.clipboard.writeText(code);
    showModal("Copied!", "Invite code copied to clipboard", null, { showInput: false, hideCancel: true });
  }

  async function showCreateRoleUI() {
    const d = document.createElement("div");
    d.innerHTML = `
      <div class="settings-input-group">
        <label class="settings-label">Role Name</label>
        <input id="roleName" placeholder="Moderator">
      </div>
      <div class="settings-input-group">
        <label class="settings-label">Role Color</label>
        <input id="roleColor" type="color" value="#7289da">
      </div>
      <div class="settings-section">
        <span class="settings-label">Permissions</span>
        <label><input type="checkbox" id="perm-sendMessages" checked> Send Messages</label><br>
        <label><input type="checkbox" id="perm-deleteChannels"> Delete Channels</label><br>
        <label><input type="checkbox" id="perm-addChannels"> Add Channels</label><br>
        <label><input type="checkbox" id="perm-kickMembers"> Kick Members</label><br>
        <label><input type="checkbox" id="perm-banMembers"> Ban Members</label><br>
        <label><input type="checkbox" id="perm-timeout"> Timeout Members</label>
      </div>
    `;
    showModal("Create Role", "", async (conf) => {
      if (conf) {
        const name = document.getElementById("roleName").value.trim();
        if (!name) return;
        const roleId = name.toLowerCase().replace(/\s+/g, "-");
        const permissions = {
          sendMessages: document.getElementById("perm-sendMessages").checked,
          readMessages: true,
          deleteChannels: document.getElementById("perm-deleteChannels").checked,
          addChannels: document.getElementById("perm-addChannels").checked,
          kickMembers: document.getElementById("perm-kickMembers").checked,
          banMembers: document.getElementById("perm-banMembers").checked,
          timeout: document.getElementById("perm-timeout").checked
        };
        await db.ref(`servers/${currentServer}/roles/${roleId}`).set({
          name: name,
          color: document.getElementById("roleColor").value,
          permissions: permissions
        });
        showServerSettingsModal();
      }
    }, { customHTML: d, showInput: false });
  }

  async function deleteRole(roleId) {
    await db.ref(`servers/${currentServer}/roles/${roleId}`).remove();
    showServerSettingsModal();
  }

  async function showMemberManageUI(member) {
    const serverSnap = await db.ref(`servers/${currentServer}`).once("value");
    const serverData = serverSnap.val();
    const memberData = serverData.members[member];
    const roles = serverData.roles || {};
    const d = document.createElement("div");
    d.innerHTML = `<div class="settings-label">Assign Roles to ${member}</div>`;
    for (let roleId in roles) {
      if (roleId === "everyone") continue;
      const role = roles[roleId];
      const hasRole = memberData.roles && memberData.roles.includes(roleId);
      const checkbox = document.createElement("div");
      checkbox.innerHTML = `<label><input type="checkbox" id="role-${roleId}" ${hasRole ? "checked" : ""}> <span style="color:${role.color}">${role.name}</span></label>`;
      d.appendChild(checkbox);
    }
    showModal("Manage " + member, "", async (conf) => {
      if (conf) {
        const newRoles = ["everyone"];
        for (let roleId in roles) {
          if (roleId === "everyone") continue;
          const cb = document.getElementById("role-" + roleId);
          if (cb && cb.checked) newRoles.push(roleId);
        }
        await db.ref(`servers/${currentServer}/members/${member}/roles`).set(newRoles);
        showServerSettingsModal();
      }
    }, { customHTML: d, showInput: false });
  }

  async function kickMember(member) {
    showModal("Kick Member", `Remove ${member} from the server?`, async (conf) => {
      if (conf) {
        await db.ref(`servers/${currentServer}/members/${member}`).remove();
        await db.ref(`users/${member}/servers/${currentServer}`).remove();
        showServerSettingsModal();
      }
    }, { showInput: false });
  }

  async function showServerJoinCreate() {
    const d = document.createElement("div");
    d.innerHTML = `
      <div style="margin-bottom:15px;">
        <button class="discord-btn" onclick="showCreateServerUI()" style="width:100%;">Create Server</button>
      </div>
      <div style="margin-bottom:15px;">
        <input id="inviteCodeInput" placeholder="Enter invite code" style="width:100%; padding:10px; background: var(--input-bg); border:none; border-radius:5px; color: var(--text);">
        <button class="discord-btn" onclick="joinServerByInvite()" style="width:100%; margin-top:10px;">Join Server</button>
      </div>
    `;
    showModal("Create or Join Server", "", null, { customHTML: d, showInput: false });
  }

  async function showCreateServerUI() {
    closeModal();
    showModal("Create Server", "Enter server name:", async (name) => {
      if (!name) return;
      const serverId = name.toLowerCase().replace(/\s+/g, "-");
      const snap = await db.ref(`servers/${serverId}`).once("value");
      if (snap.exists()) {
        showModal("Error", "Server already exists", null, { showInput: false, hideCancel: true });
        return;
      }
      const inviteCode = Math.random().toString(36).substring(2, 10).toUpperCase();
      const serverData = {
        name: name,
        owner: username,
        createdAt: Date.now(),
        inviteCode: inviteCode,
        channels: { general: true },
        roles: {
          everyone: {
            name: "Everyone",
            color: "#99aab5",
            permissions: {
              sendMessages: true,
              readMessages: true
            }
          }
        },
        members: {
          [username]: {
            joinedAt: Date.now(),
            roles: ["everyone"]
          }
        }
      };
      await db.ref(`servers/${serverId}`).set(serverData);
      await db.ref(`channels/${serverId}__general`).set({
        serverId: serverId,
        name: "general",
        createdBy: username,
        type: "text"
      });
      await db.ref(`users/${username}/servers/${serverId}`).set(true);
      serversData.push({ id: serverId, ...serverData });
      switchServer(serverId);
    }, { showInput: true, placeholder: "My Cool Server" });
  }

  async function joinServerByInvite() {
    const code = document.getElementById("inviteCodeInput").value.trim().toUpperCase();
    if (!code) return;
    const serversSnap = await db.ref("servers").once("value");
    let foundServer = null;
    serversSnap.forEach((srv) => {
      if (srv.val().inviteCode === code) {
        foundServer = { id: srv.key, ...srv.val() };
      }
    });
    if (!foundServer) {
      showModal("Error", "Invalid invite code", null, { showInput: false, hideCancel: true });
      return;
    }
    await db.ref(`users/${username}/servers/${foundServer.id}`).set(true);
    await db.ref(`servers/${foundServer.id}/members/${username}`).set({
      joinedAt: Date.now(),
      roles: ["everyone"]
    });
    if (!serversData.find(s => s.id === foundServer.id)) {
      serversData.push(foundServer);
    }
    closeModal();
    switchServer(foundServer.id);
  }

  async function toggleDesktopNotifications() {
    userSettings.desktopNotifications = !userSettings.desktopNotifications;
    await db.ref(`users/${username}/settings/desktopNotifications`).set(userSettings.desktopNotifications);
    const btn = document.getElementById("notifToggleBtn");
    if (btn) {
      btn.textContent = userSettings.desktopNotifications ? "Enabled" : "Disabled";
      btn.style.background = userSettings.desktopNotifications ? "var(--accent)" : "var(--card)";
    }
  }

  function changePassword() {
    const cur = document.getElementById("currentPassword").value,
      nP = document.getElementById("newPassword").value,
      cP = document.getElementById("confirmPassword").value,
      stat = document.getElementById("settingsStatus");
    if (!cur || !nP || !cP) { stat.textContent = "Fill all fields"; stat.style.color = "#e74c3c"; return; }
    if (nP !== cP) { stat.textContent = "Passwords don't match"; stat.style.color = "#e74c3c"; return; }
    db.ref(`users/${username}`).once("value").then((snap) => {
      if (snap.val().password === cur) {
        db.ref(`users/${username}`).update({ password: nP });
        stat.textContent = "Success!";
        stat.style.color = "#2ecc71";
      } else {
        stat.textContent = "Wrong current password";
        stat.style.color = "#e74c3c";
      }
    });
  }

  async function deleteAccountUI() {
    closeModal();
    showModal("Confirm Password", "Irreversible: Enter password to wipe account history:", async (p) => {
      const s = await db.ref(`users/${username}`).once("value");
      if (s.val().password === p) {
        const msgSnap = await db.ref("messages").once("value");
        const promises = [];
        msgSnap.forEach((ch) => ch.forEach((m) => {
          if (m.val().user === username) promises.push(db.ref(`messages/${ch.key}/${m.key}`).update({ user: "[Deleted User]" }));
        }));
        await Promise.all(promises);
        await db.ref(`users/${username}`).remove();
        await db.ref(`presence/${username}`).remove();
        location.reload();
      } else { alert("Incorrect password"); }
    }, { showInput: true });
  }

  async function deleteMsgUI(id) {
    const canDelete = await hasPermission("deleteChannels");
    const msgSnap = await db.ref(`messages/${currentChannel}/${id}`).once("value");
    const msgData = msgSnap.val();
    if (msgData.user !== username && !canDelete) {
      showModal("No Permission", "You can only delete your own messages", null, { showInput: false, hideCancel: true });
      return;
    }
    const original = document.querySelector(`.message[data-id="${id}"]`);
    if (!original) return;
    const preview = original.cloneNode(true);
    preview.querySelector(".message-menu")?.remove();
    showModal("Delete Message üóëÔ∏è", "Permanently remove this message?", (conf) => {
      if (conf) db.ref(`messages/${currentChannel}/${id}`).remove();
    }, { customHTML: preview, showInput: false });
  }

  function showEditUI(id) {
    db.ref(`messages/${currentChannel}/${id}`).once("value", (snap) => {
      const originalText = snap.val().text;
      const editContainer = document.createElement("div");
      editContainer.style.display = "flex"; editContainer.style.flexDirection = "column"; editContainer.style.gap = "12px";
      const reference = document.createElement("div");
      reference.innerHTML = `<div style="font-size: 11px; text-transform: uppercase; color: var(--muted); margin-bottom: 4px; letter-spacing: 0.5px;">Original Message</div>
        <div style="background: var(--bg); padding: 10px; border-radius: 8px; border-left: 3px solid var(--card); font-size: 14px; opacity: 0.8; font-style: italic;">
            ${escapeHTML(originalText)}
        </div>`;
      editContainer.appendChild(reference);
      const textarea = document.createElement("textarea");
      textarea.id = "nicerEditArea"; textarea.value = originalText;
      textarea.style = `width: 100%; min-height: 120px; padding: 12px; border-radius: 10px; background: var(--input-bg); color: var(--text); border: 2px solid var(--card); font-family: inherit; font-size: 15px; resize: vertical; box-sizing: border-box; outline: none; transition: border-color 0.2s;`;
      textarea.onfocus = () => (textarea.style.borderColor = "var(--accent)");
      textarea.onblur = () => (textarea.style.borderColor = "var(--card)");
      editContainer.appendChild(textarea);
      showModal("Edit Message ‚úèÔ∏è", "Edit your message:", (confirmed) => {
        if (confirmed) {
          const newText = document.getElementById("nicerEditArea").value.trim();
          if (newText && newText !== originalText) {
            db.ref(`messages/${currentChannel}/${id}`).update({ text: autoMod(newText), edited: true, lastEdited: Date.now() });
          }
        }
      }, { customHTML: editContainer, showInput: false });
      setTimeout(() => { textarea.focus(); textarea.setSelectionRange(textarea.value.length, textarea.value.length); }, 100);
    });
  }

  async function showBrowseDialog() {
    if (currentServer === "general") {
      showModal("Error", "Cannot create channels in the General server", null, { showInput: false, hideCancel: true });
      return;
    }
    const canAdd = await hasPermission("addChannels");
    if (!canAdd) {
      showModal("No Permission", "You don't have permission to create channels", null, { showInput: false, hideCancel: true });
      return;
    }
    showModal("Create Channel", "Enter channel name:", async (name) => {
      if (!name) return;
      if (containsBlacklistedWord(name)) {
        showModal("Error", "Channel name contains inappropriate content", null, { showInput: false, hideCancel: true });
        return;
      }
      const channelId = `${currentServer}__${name}`;
      const snap = await db.ref(`channels/${channelId}`).once("value");
      if (snap.exists()) {
        showModal("Error", "Channel already exists", null, { showInput: false, hideCancel: true });
        return;
      }
      await db.ref(`channels/${channelId}`).set({
        serverId: currentServer,
        name: name,
        createdBy: username,
        type: "text"
      });
      await db.ref(`servers/${currentServer}/channels/${name}`).set(true);
      joinChannel(channelId);
    }, { showInput: true, placeholder: "cool-channel" });
  }

  function replyToUI(id, user, text) {
    replyingToId = id;
    document.getElementById("replyUser").textContent = user;
    document.getElementById("replyText").textContent = text.substring(0, 30) + "...";
    document.getElementById("replyPreview").style.display = "block";
    document.getElementById("msgInput").focus();
  }

  function cancelReply() { replyingToId = null; document.getElementById("replyPreview").style.display = "none"; }
  function jumpTo(id) { const el = document.querySelector(`.message[data-id="${id}"]`); if (el) el.scrollIntoView({ behavior: "smooth", block: "center" }); }
  function startPresence() { const ref = db.ref("presence/" + username); ref.set({ status: "online", lastSeen: Date.now() }); ref.onDisconnect().remove(); }
  function cycleStatus() {
    const map = { online: "away", away: "offline", offline: "online" };
    myStatus = map[myStatus];
    db.ref("presence/" + username).update({ status: myStatus });
    document.getElementById("myStatusBtn").textContent = { online: "üü¢", away: "üü°", offline: "‚ö™" }[myStatus];
  }

  function listenToNotifs() {
    const ref = db.ref(`users/${username}/notifications`);
    ref.on("value", (snap) => {
      const b = document.getElementById("notifBadge");
      b.style.display = snap.exists() ? "inline" : "none";
      b.textContent = snap.numChildren();
      mentionCounts = {};
      snap.forEach((n) => {
        const ch = n.val().channel;
        mentionCounts[ch] = (mentionCounts[ch] || 0) + 1;
      });
      renderChannels();
    });
    ref.limitToLast(1).on("child_added", (snap) => {
      const n = snap.val();
      if (n && n.ts > loginTime && userSettings.desktopNotifications) {
        if ("Notification" in window && Notification.permission === "granted") {
          let chanName = n.channel;
          db.ref("channels/" + chanName).once("value").then(chData => {
            const ch = chData.val();
            chanName = ch ? "#" + ch.name : chanName;
            new Notification(`Mention in ${chanName}`, { body: `@${n.from}: ${n.text}`, icon: generateAvatarUrl(n.from) }).onclick = () => { window.focus(); joinChannel(n.channel); };
          });
        }
      }
    });
  }

  function showNotificationsModal() {
    db.ref(`users/${username}/notifications`).once("value", (snap) => {
      const d = document.createElement("div");
      snap.forEach((n) => {
        const i = document.createElement("div");
        i.style = "padding:8px; border-bottom:1px solid var(--card); cursor:pointer;";
        let chanName = n.val().channel;
        db.ref("channels/" + chanName).once("value").then(chData => {
          const ch = chData.val();
          chanName = ch ? "#" + ch.name : chanName;
          i.textContent = `@${n.val().from} mentioned you in ${chanName}`;
        });
        i.onclick = () => { joinChannel(n.val().channel); closeModal(); };
        d.appendChild(i);
      });
      showModal("Mentions üîî", "", null, { customHTML: d, showInput: false });
      db.ref(`users/${username}/notifications`).remove();
    });
  }

  function attachScrollHandler() {
    const m = document.getElementById("messages"), s = document.getElementById("scrollBtn");
    m.onscroll = () => { const atBottom = m.scrollHeight - m.scrollTop < 800; autoScroll = atBottom; s.classList.toggle("show", !atBottom); };
    s.onclick = () => { m.scrollTop = m.scrollHeight; autoScroll = true; };
  }

  document.getElementById("authPassword").oninput = (e) => {
    const v = e.target.value;
    document.getElementById("req-length").classList.toggle("valid", v.length >= 8);
    document.getElementById("req-upper").classList.toggle("valid", /[A-Z]/.test(v));
    document.getElementById("req-num").classList.toggle("valid", /[0-9]/.test(v));
  };
  loadExternalBlacklist();
</script>
</body>
</html>
